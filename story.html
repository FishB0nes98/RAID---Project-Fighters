<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roguelike Story Mode</title>
    <link rel="stylesheet" href="css/story.css">
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen">
        <div class="loader"></div>
        <div class="loading-text">Loading Story...</div>
    </div>

    <div class="story-container">
        <!-- Header Section -->
        <header class="story-header">
            <h1 id="story-title">Story Adventure</h1>
            <div class="story-progress">
                <div class="progress-bar">
                    <div id="progress-fill" class="progress-fill"></div>
                </div>
                <div id="progress-text" class="progress-text">Stage 1/5</div>
            </div>
        </header>

        <!-- Side Panel - Team and Info -->
        <aside class="side-panel">
            <div class="team-section">
                <h2>Your Team</h2>
                <div id="player-team" class="player-team">
                    <!-- Character slots will be loaded here -->
                    <!-- Example Structure (will be generated by JS):
                    <div class="character-card">
                        <img class="character-avatar" src="images/characters/default.png" alt="Character Name">
                        <div class="character-info">
                            <div class="character-name">Character Name</div>
                            <div class="character-stats">
                                <span class="stat-hp">HP: 100/100</span>
                                <span class="stat-mana">MP: 50/50</span>
                            </div>
                            <div class="character-tags">
                                <span class="character-tag">Tag1</span>
                            </div>
                        </div>
                    </div>
                    -->
                </div>
            </div>
            <div class="story-info">
                <h3>Story Info</h3>
                <p id="story-description">Embark on an epic adventure through dangerous lands...</p>
            </div>
            <div class="controls">
                <button id="back-button" class="control-button secondary">Back to Selection</button>
            </div>
        </aside>

        <!-- Main Content - Story Map -->
        <main class="story-map">
            <div class="map-container">
                <div class="map-path" id="map-path">
                    <!-- The path connecting stages will be drawn here -->
                </div>
                <div id="map-stages" class="map-stages">
                    <!-- Stage nodes will be loaded here -->
                </div>
                <!-- Zoom hint for users -->
                <div class="zoom-hint">
                    Use mouse wheel to zoom in/out
                </div>
            </div>
        </main>

        <!-- Stage Details Panel (initially hidden) -->
        <div id="stage-details" class="stage-details">
            <div class="stage-header">
                <h2 id="stage-name">Stage Name</h2>
                <span id="stage-difficulty" class="difficulty-badge">Difficulty: 3</span>
            </div>
            <div class="stage-image-container">
                <img id="stage-image" src="images/stages/default.jpg" alt="Stage preview">
                <div class="stage-overlay"></div>
            </div>
            <div class="stage-description" id="stage-description">
                Stage description will appear here...
            </div>
            <div class="stage-enemies">
                <h3>Enemies</h3>
                <div id="enemy-list" class="enemy-list">
                    <!-- Enemy previews will be loaded here -->
                </div>
            </div>
            <div class="stage-rewards">
                <h3>Rewards</h3>
                <div id="reward-list" class="reward-list">
                    <!-- Reward previews will be loaded here -->
                </div>
            </div>

            <!-- NEW: Container for stage choices -->
            <div id="stage-choices-container" class="stage-info-section hidden">
                <h3>Make a Choice</h3>
                <div id="choice-list" class="choice-options">
                    <!-- Choices will be populated here -->
                </div>
            </div>
            <!-- END NEW -->

            <!-- NEW: Container for recruitment offers -->
            <div id="stage-recruit-container" class="stage-info-section hidden">
                <h3>Potential Allies</h3>
                <div id="recruit-list" class="character-grid"> <!-- Reuse character-grid styling -->
                    <!-- Recruit offers will be populated here -->
                </div>
            </div>
            <!-- END NEW -->

            <div class="stage-actions">
                <button id="start-stage-button" class="action-button primary">Begin Battle</button>
                <button id="close-details-button" class="action-button secondary">Close</button>
            </div>
        </div>

        <!-- Victory Screen (initially hidden) -->
        <div id="victory-screen" class="victory-screen">
            <div class="victory-content">
                <h2>Stage Cleared!</h2>
                <div class="victory-rewards">
                    <h3>Rewards Earned</h3>
                    <div id="victory-reward-list" class="victory-reward-list">
                        <!-- Earned rewards will be shown here -->
                    </div>
                </div>
                <div class="victory-actions">
                    <button id="continue-button" class="action-button primary">Continue Adventure</button>
                </div>
            </div>
        </div>

        <!-- Game Over Screen (initially hidden) -->
        <div id="game-over-screen" class="game-over-screen">
            <div class="game-over-content">
                <h2>Game Over</h2>
                <p>Your team has been defeated!</p>
                <div class="game-over-actions">
                    <button id="retry-button" class="action-button primary">Retry Stage</button>
                    <button id="quit-button" class="action-button secondary">Quit Adventure</button>
                </div>
            </div>
        </div>

        <!-- Story Completion Screen (initially hidden) -->
        <div id="story-complete-screen" class="victory-screen">
            <div class="victory-content">
                <h2>Story Complete!</h2>
                <p>Congratulations! You have completed this adventure.</p>
                <div class="victory-actions">
                    <button id="new-story-button" class="action-button primary">Choose New Story</button>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW: Character Selection Modal for Choices -->
    <div id="character-selection-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button" onclick="closeCharacterSelectionModal()">&times;</span>
            <h2>Select Character</h2>
            <p id="choice-modal-description"></p> <!-- To show which choice is being applied -->
            <div id="character-selection-list" class="character-grid">
                <!-- Character cards will be populated here -->
            </div>
        </div>
    </div>
    <!-- END NEW -->

    <!-- Firebase JS SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-database-compat.js"></script>

    <!-- Firebase Config -->
    <script src="js/firebase-config.js"></script>

    <!-- Game Scripts -->
    <script src="js/story/default-images.js"></script>
    <script src="js/story/story-manager.js"></script>
    <script src="js/story/story-ui.js"></script>

    <!-- Helper Functions -->
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Hide loading screen when everything is loaded
            function hideLoadingScreen() {
                const loadingScreen = document.getElementById('loading-screen');
                loadingScreen.style.opacity = '0';
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                }, 500);
            }

            // Initialize the story manager
            try {
                // --- Firebase Auth Check ---
                firebaseAuth.onAuthStateChanged(async (user) => {
                    if (user) {
                        console.log("User logged in for story mode:", user.uid);
                        const userId = user.uid;

                        // Proceed with story initialization now that user is confirmed
                        await initializeStory(userId);

                    } else {
                        console.log("User not logged in. Redirecting to index.html");
                        window.location.href = 'index.html';
                    }
                });
                // --- End Firebase Auth Check ---

            } catch (error) {
                console.error('Failed to initialize story or check auth:', error);
                hideLoadingScreen(); // Ensure loading screen hides on error
                alert('Failed to load story or authenticate. Please try again.');
                window.location.href = 'character-selector.html'; // Redirect back
            }

            // --- NEW Function to contain story initialization logic ---
            async function initializeStory(userId) {
                let currentStep = "Starting initialization";
                try {
                     currentStep = "Parsing URL and localStorage";
                     const urlParams = new URLSearchParams(window.location.search);
                     const storyId = urlParams.get('story');

                     if (!storyId) {
                        alert('Missing story ID. Redirecting to character selection.');
                        window.location.href = 'character-selector.html';
                        return;
                    }

                    currentStep = "Initializing StoryManager/UI Instances";
                    window.storyManager = new StoryManager(userId);
                    window.storyUI = new StoryUI(window.storyManager);

                    currentStep = "Initializing UI Elements (storyUI.initialize)";
                    // Initialize UI FIRST to select DOM elements and set up handlers
                    window.storyUI.initialize(); 

                    currentStep = "Assigning StoryManager Callbacks";
                    // Assign callbacks AFTER UI is initialized
                    window.storyManager.onStoryLoaded = window.storyUI.handleStoryLoaded.bind(window.storyUI);
                    window.storyManager.onStageCompleted = window.storyUI.handleStageCompleted.bind(window.storyUI);

                    currentStep = "Loading Story Data (storyManager.loadStory)";
                    // Load story data - this will trigger onStoryLoaded (handleStoryLoaded)
                    // which now has valid element references for rendering
                    await window.storyManager.loadStory(storyId);

                    // storyUI.initialize() already ran, no need to call again here

                    currentStep = "Hiding Loading Screen";
                    hideLoadingScreen();

                } catch (error) {
                    console.error('Failed to initialize story at step:', currentStep, error);
                    alert(`Failed to load story (Error during: ${currentStep}). Please check console and try again. Details: ${error.message}`);
                    hideLoadingScreen();
                }
            }
            // --- END NEW Function ---
        });

        // Global function to close the character selection modal
        function closeCharacterSelectionModal() {
            if (window.storyUI) {
                window.storyUI.closeCharacterSelectionModal();
            }
        }

        // --- Placeholder Helper Functions ---
        function showLoadingOverlay(message) {
            console.log(`[Placeholder] Show Loading: ${message}`);
            // In a real implementation, you would show a blocking overlay UI element
        }

        function hideLoadingOverlay() {
            console.log("[Placeholder] Hide Loading");
            // Hide the overlay UI element
        }

        function showPopupMessage(message, type = 'info', duration = 3000) {
            console.log(`[Placeholder] Popup (${type}, ${duration}ms): ${message}`);
            // In a real implementation, show a non-blocking notification
        }
        // --- End Placeholder Helper Functions ---
    </script>
</body>
</html> 