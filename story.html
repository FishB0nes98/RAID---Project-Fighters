<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roguelike Story Mode</title>
    <link rel="stylesheet" href="css/story.css">
    <link rel="stylesheet" href="css/inventory-system.css">
    <link rel="stylesheet" href="css/loot-rewards.css">
    <link rel="stylesheet" href="css/crafting-modal.css">
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- NEW: Slideshow Container - Moved to be a direct child of body -->
    <div id="story-slideshow-container" class="story-slideshow-container"></div>
    <!-- END NEW -->

    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen">
        <div class="loader"></div>
        <div class="loading-text">Loading Story...</div>
    </div>

    <div class="story-container">
        <!-- Header Section -->
        <header class="story-header">
            <h1 id="story-title">Story Adventure</h1>
            <div class="story-progress">
                <div class="progress-bar">
                    <div id="progress-fill" class="progress-fill"></div>
                </div>
                <div id="progress-text" class="progress-text">Stage 1/5</div>
            </div>
        </header>

        <!-- Side Panel - Team and Info -->
        <aside class="side-panel">
            <div class="team-section">
                <h2>Your Team</h2>
                <div id="player-team" class="player-team">
                    <!-- Character slots will be loaded here -->
                    <!-- Example Structure (will be generated by JS):
                    <div class="character-card">
                        <img class="character-avatar" src="images/characters/default.png" alt="Character Name">
                        <div class="character-info">
                            <div class="character-name">Character Name</div>
                            <div class="character-stats">
                                <span class="stat-hp">HP: 100/100</span>
                                <span class="stat-mana">MP: 50/50</span>
                            </div>
                            <div class="character-tags">
                                <span class="character-tag">Tag1</span>
                            </div>
                        </div>
                    </div>
                    -->
                </div>
            </div>
            <div class="story-info">
                <h3>Story Info</h3>
                <p id="story-description">Embark on an epic adventure through dangerous lands...</p>
            </div>
            <div class="controls">
                <button id="global-inventory-button" class="control-button primary">Global Inventory</button>
                <button id="crafting-modal-button" class="control-button primary">Crafting</button>
                <button id="back-button" class="control-button secondary">Back to Selection</button>
            </div>
        </aside>

        <!-- Main Content - Story Map -->
        <main class="story-map">
            <div class="map-container">
                <div class="map-path" id="map-path">
                    <!-- The path connecting stages will be drawn here -->
                </div>
                <div id="map-stages" class="map-stages">
                    <!-- Stage nodes will be loaded here -->
                </div>
                <!-- Zoom hint for users -->
                <div class="zoom-hint">
                    Use mouse wheel to zoom in/out
                </div>
            </div>
        </main>

    </div> <!-- Closing .story-container here -->

        <!-- Stage Details Panel (initially hidden) -->
        <div id="stage-details" class="stage-details">
            <div class="stage-header">
                <h2 id="stage-name">Stage Name</h2>
                <span id="stage-difficulty" class="difficulty-badge">Difficulty: 3</span>
            </div>
            <div class="stage-image-container">
                <img id="stage-image" src="images/stages/default.jpg" alt="Stage preview">
                <div class="stage-overlay"></div>
            </div>
            <div class="stage-description" id="stage-description">
                Stage description will appear here...
            </div>
            <div class="stage-enemies">
                <h3>Enemies</h3>
                <div id="enemy-list" class="enemy-list">
                    <!-- Enemy previews will be loaded here -->
                </div>
            </div>
            <div class="stage-rewards">
                <h3>Rewards</h3>
                <div id="reward-list" class="reward-list">
                    <!-- Reward previews will be loaded here -->
                </div>
            </div>

            <!-- Stage Modifiers Section -->
            <div id="stage-modifiers-section" class="stage-info-section">
                <h3>Stage Effects</h3>
                <div id="stage-modifiers-list" class="stage-modifiers-list">
                    <!-- Stage modifiers will be loaded here -->
                </div>
            </div>

            <!-- NEW: Container for stage choices -->
            <div id="stage-choices-container" class="stage-info-section hidden">
                <h3>Make a Choice</h3>
                <div id="choice-list" class="choice-options">
                    <!-- Choices will be populated here -->
                </div>
            </div>
            <!-- END NEW -->

            <!-- NEW: Container for recruitment offers -->
            <div id="stage-recruit-container" class="stage-info-section hidden">
                <h3>Potential Allies</h3>
                <div id="recruit-list" class="character-grid"> <!-- Reuse character-grid styling -->
                    <!-- Recruit offers will be populated here -->
                </div>
            </div>
            <!-- END NEW -->

            <div class="stage-actions">
                <button id="start-stage-button" class="action-button primary">Begin Battle</button>
                <button id="close-details-button" class="action-button secondary">Close</button>
            </div>
        </div>

        <!-- Victory Screen (initially hidden) -->
        <div id="victory-screen" class="victory-screen">
            <div class="victory-content">
                <h2>Stage Cleared!</h2>
                <div class="victory-rewards">
                    <h3>Rewards Earned</h3>
                    <div id="victory-reward-list" class="victory-reward-list">
                        <!-- Earned rewards will be shown here -->
                    </div>
                </div>
                <div class="victory-actions">
                    <button id="continue-button" class="action-button primary">Continue Adventure</button>
                </div>
            </div>
        </div>

        <!-- Game Over Screen (initially hidden) -->
        <div id="game-over-screen" class="game-over-screen">
            <div class="game-over-content">
                <h2>Game Over</h2>
                <p>Your team has been defeated!</p>
                <div class="game-over-actions">
                    <button id="retry-button" class="action-button primary">Retry Stage</button>
                    <button id="quit-button" class="action-button secondary">Quit Adventure</button>
                </div>
            </div>
        </div>

        <!-- Story Completion Screen (initially hidden) -->
        <div id="story-complete-screen" class="victory-screen">
            <div class="victory-content">
                <h2>Story Complete!</h2>
                <p>Congratulations! You have completed this adventure.</p>
                <div class="victory-actions">
                    <button id="new-story-button" class="action-button primary">Choose New Story</button>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW: Character Selection Modal for Choices -->
    <div id="character-selection-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button" onclick="closeCharacterSelectionModal()">&times;</span>
            <h2>Select Character</h2>
            <p id="choice-modal-description"></p> <!-- To show which choice is being applied -->
            <div id="character-selection-list" class="character-grid">
                <!-- Character cards will be populated here -->
            </div>
        </div>
    </div>
    <!-- END NEW -->

    <!-- Talent Modal -->
    <div id="talent-modal" class="talent-modal hidden">
        <div class="talent-modal-content">
            <div class="talent-modal-header">
                <h2 id="talent-modal-title">Character Talents</h2>
                <button class="close-button talent-close-btn" onclick="closeTalentModal()">&times;</button>
            </div>
            <div class="talent-modal-body">
                <iframe id="talent-iframe" src="" frameborder="0" width="100%" height="100%"></iframe>
            </div>
        </div>
    </div>



    <!-- Firebase JS SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-database-compat.js"></script>

    <!-- Firebase Config -->
    <script src="js/firebase-config.js"></script>

    <!-- Inventory System Scripts -->
    <script src="js/raid-game/item-system.js"></script>
    <script src="js/raid-game/inventory-integration.js"></script>
    <script src="js/raid-game/inventory-ui-manager.js"></script>
    
    <!-- Loot System Scripts -->
    <script src="js/raid-game/loot-manager.js"></script>
    <script src="js/raid-game/loot-ui-manager.js"></script>
    
    <!-- Crafting Modal Script -->
    <script src="js/raid-game/crafting-modal.js"></script>

    <!-- Game Scripts -->
    <script src="js/raid-game/character.js"></script>
    <script src="js/raid-game/character-xp-manager.js"></script>
    <script src="js/raid-game/stage-modifiers.js"></script>
    <script src="js/raid-game/talent-manager.js"></script>
    <script src="js/story/default-images.js"></script>
    <script src="js/story/story-manager.js"></script>
    <script src="js/story/story-ui.js"></script>
    <script src="js/story/story-slideshow.js"></script> <!-- NEW -->

    <!-- Helper Functions -->
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Hide loading screen when everything is loaded
            function hideLoadingScreen() {
                const loadingScreen = document.getElementById('loading-screen');
                loadingScreen.style.opacity = '0';
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                }, 500);
            }

            // Initialize the story manager
            try {
                // --- Firebase Auth Check ---
                firebaseAuth.onAuthStateChanged(async (user) => {
                    if (user) {
                        console.log("User logged in for story mode:", user.uid);
                        const userId = user.uid;

                        // Proceed with story initialization now that user is confirmed
                        await initializeStory(userId);

                    } else {
                        console.log("User not logged in. Redirecting to index.html");
                        window.location.href = 'index.html';
                    }
                });
                // --- End Firebase Auth Check ---

            } catch (error) {
                console.error('Failed to initialize story or check auth:', error);
                hideLoadingScreen(); // Ensure loading screen hides on error
                alert('Failed to load story or authenticate. Please try again.');
                window.location.href = 'character-selector.html'; // Redirect back
            }

            // --- NEW Function to contain story initialization logic ---
            async function initializeStory(userId) {
                if (window.storyInitialized) {
                    console.warn('[Story] Story already initialized. Skipping second initialization.');
                    return;
                }
                window.storyInitialized = true; // Set flag to prevent re-initialization

                let currentStep = "Starting initialization";
                try {
                     currentStep = "Parsing URL and localStorage";
                     const urlParams = new URLSearchParams(window.location.search);
                     const storyId = urlParams.get('story');

                     if (!storyId) {
                        alert('Missing story ID. Redirecting to character selection.');
                        window.location.href = 'character-selector.html';
                        return;
                    }

                    currentStep = "Initializing Inventory System";
                    // Set story mode flag to prevent auto-initialization conflicts
                    window.isStoryMode = true;
                    
                    // Initialize inventory system components with better error handling
                    console.log('[Story] === INVENTORY SYSTEM INITIALIZATION ===');
                    
                    // Check if classes are available
                    const classesAvailable = {
                        ItemRegistry: typeof ItemRegistry !== 'undefined',
                        GlobalInventory: typeof GlobalInventory !== 'undefined',
                        CharacterInventory: typeof CharacterInventory !== 'undefined',
                        InventoryUIManager: typeof InventoryUIManager !== 'undefined'
                    };
                    
                    console.log('[Story] Class availability check:', classesAvailable);
                    
                    // Create ItemRegistry
                    if (classesAvailable.ItemRegistry) {
                        if (!window.ItemRegistry) {
                            window.ItemRegistry = new ItemRegistry();
                            console.log('[Story] ‚úì ItemRegistry created successfully');
                        } else {
                            console.log('[Story] ‚úì ItemRegistry already exists');
                        }
                    } else {
                        console.error('[Story] ‚úó ItemRegistry class not found! Check if item-system.js loaded correctly.');
                        throw new Error('ItemRegistry class not available');
                    }
                    
                    // Create GlobalInventory
                    if (classesAvailable.GlobalInventory) {
                        if (!window.GlobalInventory) {
                            window.GlobalInventory = new GlobalInventory();
                            console.log('[Story] ‚úì GlobalInventory created successfully');
                        } else {
                            console.log('[Story] ‚úì GlobalInventory already exists');
                        }
                    } else {
                        console.error('[Story] ‚úó GlobalInventory class not found! Check if item-system.js loaded correctly.');
                        throw new Error('GlobalInventory class not available');
                    }
                    
                    // Create CharacterInventories Map
                    if (!window.CharacterInventories) {
                        window.CharacterInventories = new Map();
                        console.log('[Story] ‚úì CharacterInventories Map created successfully');
                    } else {
                        console.log('[Story] ‚úì CharacterInventories Map already exists');
                    }
                    
                    // Verify all instances are properly created
                    const inventorySystemReady = !!(window.ItemRegistry && window.GlobalInventory && window.CharacterInventories);
                    console.log('[Story] Inventory system ready:', inventorySystemReady);
                    
                    if (!inventorySystemReady) {
                        throw new Error('Inventory system initialization failed');
                    }
                    
                    console.log('[Story] === INVENTORY SYSTEM INITIALIZED ===');
                    
                    currentStep = "Loading User Inventory from Firebase";
                    // Load user's saved inventory data from Firebase
                    try {
                        console.log('[Story] Loading user inventory from Firebase...');
                        
                        // Get user's data from Firebase
                        const userRef = firebase.database().ref(`users/${userId}`);
                        const snapshot = await userRef.once('value');
                        const userData = snapshot.val();
                        
                        if (userData && userData.globalInventory) {
                            console.log('[Story] Found saved global inventory:', userData.globalInventory);
                            
                            // Load the saved inventory data
                            if (userData.globalInventory.items && Array.isArray(userData.globalInventory.items)) {
                                // New format: {items: [...], lastUpdated: timestamp}
                                console.log('[Story] Loading new format inventory with', userData.globalInventory.items.length, 'items');
                                window.GlobalInventory.deserialize(userData.globalInventory.items);
                                console.log('[Story] ‚úì Loaded global inventory from Firebase (new format):', window.GlobalInventory.items.length, 'items');
                            } else if (Array.isArray(userData.globalInventory)) {
                                // Old format: direct array
                                console.log('[Story] Loading old format inventory with', userData.globalInventory.length, 'items');
                                window.GlobalInventory.items = userData.globalInventory;
                                console.log('[Story] ‚úì Loaded global inventory from Firebase (old format):', window.GlobalInventory.items.length, 'items');
                            } else {
                                console.log('[Story] ‚ö†Ô∏è Saved inventory format is not recognized, initializing empty inventory');
                                window.GlobalInventory.items = [];
                            }
                        } else {
                            console.log('[Story] ‚ö†Ô∏è No saved global inventory found, starting with empty inventory');
                            window.GlobalInventory.items = [];
                        }
                        
                        // Store userData globally for other systems to use
                        window.userData = userData || {};
                        
                    } catch (error) {
                        console.error('[Story] Error loading inventory from Firebase:', error);
                        console.log('[Story] ‚ö†Ô∏è Continuing with empty inventory');
                        window.GlobalInventory.items = [];
                    }
                    
                    currentStep = "Initializing Stage Modifiers Registry";
                    // Initialize stage modifiers registry for stage details
                    if (typeof StageModifiersRegistry !== 'undefined') {
                        window.stageModifiersRegistry = new StageModifiersRegistry();
                        console.log('[Story] ‚úì Stage modifiers registry initialized');
                    } else {
                        console.warn('[Story] ‚ö†Ô∏è StageModifiersRegistry not available - stage modifiers will show basic info only');
                    }

                    currentStep = "Initializing StoryManager/UI Instances";
                    window.storyManager = new StoryManager(userId);
                    window.storyUI = new StoryUI(window.storyManager);

                    currentStep = "Initializing UI Elements (storyUI.initialize)";
                    // Initialize UI FIRST to select DOM elements and set up handlers
                    window.storyUI.initialize(); 

                    currentStep = "Setting up Crafting Modal Button";
                    // Setup crafting modal button event listener
                    const craftingButton = document.getElementById('crafting-modal-button');
                    if (craftingButton) {
                        craftingButton.addEventListener('click', () => {
                            console.log('[Story] Crafting button clicked');
                            if (window.storyUI && typeof window.storyUI.openCraftingModal === 'function') {
                                window.storyUI.openCraftingModal();
                            } else {
                                console.error('[Story] StoryUI openCraftingModal method not available');
                            }
                        });
                        console.log('[Story] ‚úì Crafting button event listener added');
                    } else {
                        console.warn('[Story] ‚ö†Ô∏è Crafting button not found');
                    }

                    currentStep = "Assigning StoryManager Callbacks";
                    // Assign callbacks AFTER UI is initialized
                    window.storyManager.onStoryLoaded = window.storyUI.handleStoryLoaded.bind(window.storyUI);
                    window.storyManager.onStageCompleted = window.storyUI.handleStageCompleted.bind(window.storyUI);

                    currentStep = "Loading Story Data (storyManager.loadStory)";
                    // Load story data - this will trigger onStoryLoaded (handleStoryLoaded)
                    // which now has valid element references for rendering
                    await window.storyManager.loadStory(storyId);

                    // storyUI.initialize() already ran, no need to call again here

                    currentStep = "Hiding Loading Screen";
                    hideLoadingScreen();

                    // Add console test functions for debugging inventory system
                    window.testInventorySystem = function() {
                        console.log('=== INVENTORY SYSTEM TEST ===');
                        console.log('ItemRegistry:', !!window.ItemRegistry);
                        console.log('GlobalInventory:', !!window.GlobalInventory);
                        console.log('CharacterInventories:', !!window.CharacterInventories);
                        console.log('InventoryUIManager:', !!window.InventoryUIManager);
                        console.log('storyInventoryUIManager:', !!window.storyInventoryUIManager);
                        console.log('InventoryIntegrationManager:', !!window.InventoryIntegrationManager);
                        
                        if (window.GlobalInventory) {
                            console.log('Global inventory items:', window.GlobalInventory.getAllItems());
                        }
                        
                        if (window.CharacterInventories) {
                            console.log('Character inventories size:', window.CharacterInventories.size);
                        }
                        
                        console.log('Test complete. Try: testOpenCharacterInventory("schoolboy_siegfried")');
                    };
                    
                    window.testOpenCharacterInventory = function(characterId = 'schoolboy_siegfried') {
                        console.log('Testing character inventory open for:', characterId);
                        if (window.storyUI) {
                            window.storyUI.openCharacterInventory(characterId);
                        } else {
                            console.error('Story UI not found');
                        }
                    };
                    
                    window.testOpenGlobalInventory = function() {
                        console.log('Testing global inventory open');
                        if (window.storyUI) {
                            window.storyUI.openGlobalInventory();
                        } else {
                            console.error('Story UI not found');
                        }
                    };
                    
                    console.log('‚úÖ Story initialization complete!');
                    
                    // Add debug function to test crafting modal with some items
                    window.testCraftingModal = function() {
                        console.log('üß™ Testing crafting modal with sample items...');
                        
                        if (!window.GlobalInventory) {
                            console.error('‚ùå GlobalInventory not available');
                            return;
                        }
                        
                        console.log('üì¶ Current global inventory before adding test items:', window.GlobalInventory.getAllItems());
                        console.log('üì¶ Current global inventory items array:', window.GlobalInventory.items);
                        
                        // Add some test items including lootboxes
                        window.GlobalInventory.addItem('atlantean_treasure_chest', 2);
                        window.GlobalInventory.addItem('health_potion', 5);
                        window.GlobalInventory.addItem('mana_potion', 3);
                        
                        console.log('‚úÖ Added test items to global inventory');
                        console.log('üì¶ Global inventory contents after adding:', window.GlobalInventory.getAllItems());
                        console.log('üì¶ Global inventory items array after adding:', window.GlobalInventory.items);
                        
                        // Test opening the crafting modal
                        if (window.storyUI && typeof window.storyUI.openCraftingModal === 'function') {
                            window.storyUI.openCraftingModal();
                        } else {
                            console.error('‚ùå StoryUI openCraftingModal not available');
                        }
                    };
                    
                    // Add function to check current inventory status
                    window.checkInventoryStatus = function() {
                        console.log('=== INVENTORY STATUS CHECK ===');
                        console.log('GlobalInventory exists:', !!window.GlobalInventory);
                        if (window.GlobalInventory) {
                            console.log('Items array:', window.GlobalInventory.items);
                            console.log('Items count:', window.GlobalInventory.items.length);
                            console.log('All items (expanded):', window.GlobalInventory.getAllItems());
                            console.log('Item stacks:', window.GlobalInventory.getItemStacks());
                        }
                        console.log('UserData:', window.userData);
                        console.log('=== END STATUS CHECK ===');
                    };
                    
                    // Add debug function to inspect inventory system status
                    window.debugInventorySystem = function() {
                        console.log('=== INVENTORY SYSTEM DEBUG ===');
                        
                        const systemStatus = {
                            ItemRegistry: {
                                exists: !!window.ItemRegistry,
                                instance: window.ItemRegistry,
                                type: typeof window.ItemRegistry
                            },
                            GlobalInventory: {
                                exists: !!window.GlobalInventory,
                                instance: window.GlobalInventory,
                                type: typeof window.GlobalInventory
                            },
                            CharacterInventories: {
                                exists: !!window.CharacterInventories,
                                instance: window.CharacterInventories,
                                type: typeof window.CharacterInventories,
                                isMap: window.CharacterInventories instanceof Map
                            },
                            InventoryUIManager: {
                                class_exists: !!window.InventoryUIManager,
                                instance_exists: !!window.storyInventoryUIManager,
                                class_type: typeof window.InventoryUIManager,
                                instance_type: typeof window.storyInventoryUIManager
                            },
                            storyMode: window.isStoryMode
                        };
                        
                        console.log('System Status:', systemStatus);
                        
                        // Test creating instances if they don't exist
                        if (typeof ItemRegistry !== 'undefined' && !window.ItemRegistry) {
                            console.log('‚ö†Ô∏è ItemRegistry class available but no global instance!');
                        }
                        if (typeof GlobalInventory !== 'undefined' && !window.GlobalInventory) {
                            console.log('‚ö†Ô∏è GlobalInventory class available but no global instance!');
                        }
                        
                        return systemStatus;
                    };
                    
                    console.log('üß™ Test functions available: testInventorySystem(), testOpenCharacterInventory(), testOpenGlobalInventory(), debugInventorySystem(), debugInventoryModal(), testCraftingModal(), checkInventoryStatus()'); 
                    
                    // Add debug function to inspect modal DOM
                    window.debugInventoryModal = function() {
                        console.log('=== INVENTORY MODAL DEBUG ===');
                        
                        const modal = document.getElementById('inventory-modal');
                        console.log('Modal found:', !!modal);
                        
                        if (modal) {
                            console.log('Modal classes:', modal.className);
                            console.log('Modal visible:', modal.classList.contains('visible'));
                            
                            const characterGrid = document.getElementById('character-inventory-grid');
                            const globalGrid = document.getElementById('global-inventory-grid');
                            
                            console.log('Character grid found:', !!characterGrid);
                            console.log('Global grid found:', !!globalGrid);
                            
                            if (characterGrid) {
                                console.log('Character grid children count:', characterGrid.children.length);
                                console.log('Character grid innerHTML length:', characterGrid.innerHTML.length);
                                console.log('Character grid HTML:', characterGrid.innerHTML);
                            }
                            
                            if (globalGrid) {
                                console.log('Global grid children count:', globalGrid.children.length);
                                console.log('Global grid innerHTML length:', globalGrid.innerHTML.length);
                            }
                        }
                        
                        console.log('=== DEBUG COMPLETE ===');
                    };
                    
                    console.log('üß™ Debug function available: debugInventoryModal()');

                } catch (error) {
                    console.error('Failed to initialize story at step:', currentStep, error);
                    alert(`Failed to load story (Error during: ${currentStep}). Please check console and try again. Details: ${error.message}`);
                    hideLoadingScreen();
                }
            }
            // --- END NEW Function ---

            // Test function to verify character level loading
            window.testCharacterLevels = function() {
                console.log('üß™ Testing character level loading...');
                
                if (!window.storyManager || !window.storyManager.playerTeam) {
                    console.error('‚ùå Story manager or player team not available');
                    return;
                }
                
                const team = window.storyManager.playerTeam;
                console.log(`üìä Testing ${team.length} characters:`);
                
                team.forEach(character => {
                    console.log(`  - ${character.name}: Level ${character.level || 'NOT SET'} (${character.experience || 0} XP)`);
                });
                
                // Test CharacterXPManager availability
                if (window.characterXPManager && window.characterXPManager.initialized) {
                    console.log('‚úÖ CharacterXPManager is available and initialized');
                } else {
                    console.error('‚ùå CharacterXPManager not available or not initialized');
                }
                
                console.log('üß™ Test complete!');
            };
            
            console.log('üß™ Test function available: testCharacterLevels()');
        });

        // Global function to close the character selection modal
        function closeCharacterSelectionModal() {
            if (window.storyUI) {
                window.storyUI.closeCharacterSelectionModal();
            }
        }

        // Global function to close the crafting modal
        function closeCraftingModal() {
            if (window.CraftingModal && typeof window.CraftingModal.hide === 'function') {
                window.CraftingModal.hide();
            } else {
                console.error('CraftingModal not available');
            }
        }

        // Global function to open the crafting modal
        function openCraftingModal() {
            if (window.CraftingModal && typeof window.CraftingModal.show === 'function') {
                window.CraftingModal.show();
            } else {
                console.error('CraftingModal not available');
            }
        }

        // Global function to close the talent modal
        function closeTalentModal() {
            if (window.storyUI) {
                window.storyUI.closeTalentModal();
            }
        }

        // Listen for messages from iframe (talent modal)
        window.addEventListener('message', function(event) {
            // Only accept messages from the same origin for security
            if (event.origin !== window.location.origin) {
                return;
            }
            
            if (event.data && event.data.action === 'closeTalentModal') {
                closeTalentModal();
            }
        });

        // --- Placeholder Helper Functions ---
        function showLoadingOverlay(message) {
            console.log(`[Placeholder] Show Loading: ${message}`);
            // In a real implementation, you would show a blocking overlay UI element
        }

        function hideLoadingOverlay() {
            console.log("[Placeholder] Hide Loading");
            // Hide the overlay UI element
        }

        function showPopupMessage(message, type = 'info', duration = 3000) {
            console.log(`[Placeholder] Popup (${type}, ${duration}ms): ${message}`);
            // In a real implementation, show a non-blocking notification
        }
        // --- End Placeholder Helper Functions ---
    </script>
</body>
</html>
