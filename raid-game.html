<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Performance and Rendering Optimizations -->
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    
    <!-- Preload Critical Assets -->
    <link rel="preload" href="js/raid-game/game-manager.js" as="script">
    <link rel="preload" href="js/raid-game/character.js" as="script">
    <link rel="preload" href="js/raid-game/talent-modifiers/infernal_ibuki_talent_modifier.js" as="script">
    <script src="js/skins/skin-registry.js"></script>
    <link rel="preload" href="css/raid-game.css" as="style">
    
    <!-- Performance Hints -->
    <link rel="dns-prefetch" href="//fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <title>Roguelike Raid Battle</title>
    
    <!-- Hardware Acceleration CSS -->
    <style>
        /* Minimal critical CSS for initial render */
        html, body {
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        /* Essential hardware acceleration */
        .characters-container, 
        .character-slot, 
        .ability, 
        .battle-log-container, 
        .stage-background {
            transform: translate3d(0, 0, 0);
            will-change: transform, opacity;
            backface-visibility: hidden;
        }

        /* Lazy loading placeholders */
        img {
            content-visibility: auto;
            contain-intrinsic-size: 1px 1px;
        }

        /* Critical path rendering */
        .game-container {
            contain: layout style paint;
            will-change: contents;
        }

        /* Optimize animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Performance-critical elements */
        .hp-bar, .mana-bar, .shield-bar {
            transform: translate3d(0, 0, 0);
            will-change: width;
        }
        
        /* Enable GPU acceleration for the entire page */
        html {
            -webkit-transform: translateZ(0);
            -moz-transform: translateZ(0);
            -ms-transform: translateZ(0);
            -o-transform: translateZ(0);
            transform: translateZ(0);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        body {
            /* Force hardware acceleration */
            transform: translate3d(0, 0, 0);
            -webkit-transform: translate3d(0, 0, 0);
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            
            /* Performance optimizations */
            contain: layout style paint;
            will-change: auto;
        }
        
        /* Optimize animations and transitions */
        * {
            -webkit-transform-style: preserve-3d;
            transform-style: preserve-3d;
        }
        
        /* Character containers - GPU acceleration */
        .characters-container {
            transform: translate3d(0, 0, 0);
            will-change: transform;
            contain: layout style paint;
        }
        
        /* Character slots - GPU acceleration */
        .character-slot {
            transform: translate3d(0, 0, 0);
            backface-visibility: hidden;
            will-change: transform, opacity;
            contain: layout style paint;
        }
        
        /* Abilities - GPU acceleration */
        .ability {
            transform: translate3d(0, 0, 0);
            backface-visibility: hidden;
            will-change: transform, opacity;
        }
        
        /* Battle log - GPU acceleration */
        .battle-log-container {
            transform: translate3d(0, 0, 0);
            will-change: transform;
            contain: layout style paint;
        }
        
        /* Stage background - GPU acceleration */
        .stage-background {
            transform: translate3d(0, 0, 0);
            backface-visibility: hidden;
            will-change: transform, opacity;
            contain: strict;
        }
        
        /* Panels - GPU acceleration */
        .talents-panel,
        .statistics-panel,
        .quests-panel {
            transform: translate3d(0, 0, 0);
            will-change: transform;
            contain: layout style paint;
        }
        
        /* VFX and animations - GPU acceleration */
        [class*="vfx"],
        [class*="animation"],
        [class*="particle"] {
            transform: translate3d(0, 0, 0);
            backface-visibility: hidden;
            will-change: transform, opacity;
        }
        
        /* Progress bars - GPU acceleration */
        .progress-bar,
        .hp-bar,
        .mana-bar,
        .shield-bar {
            transform: translate3d(0, 0, 0);
            will-change: transform, width;
        }
        
        /* Tooltips - GPU acceleration */
        .tooltip {
            transform: translate3d(0, 0, 0);
            backface-visibility: hidden;
            will-change: transform, opacity;
        }
        
        /* Notifications - GPU acceleration */
        .quest-completion-notification,
        .quest-progress-notification {
            transform: translate3d(0, 0, 0);
            backface-visibility: hidden;
            will-change: transform, opacity;
        }
        
        /* Game over screen - GPU acceleration */
        .game-over-container {
            transform: translate3d(0, 0, 0);
            will-change: transform, opacity;
            contain: layout style paint;
        }
        
        /* Loading screen - GPU acceleration */
        .loading-screen {
            transform: translate3d(0, 0, 0);
            will-change: transform, opacity;
            contain: strict;
        }
        
        /* Optimize image rendering */
        img {
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
            transform: translate3d(0, 0, 0);
        }
        
        /* Stage modifiers - GPU acceleration */
        .stage-modifiers-container {
            transform: translate3d(0, 0, 0);
            will-change: transform, opacity;
            contain: layout style paint;
        }
    </style>
    
    <!-- Performance Optimizations -->
    <link rel="preload" as="style" href="css/raid-game.css">
    <link rel="stylesheet" href="css/raid-game.css" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="css/raid-game.css"></noscript>

    <!-- Combine multiple CSS files -->
    <link rel="preload" as="style" href="css/combined-abilities.css">
    <link rel="stylesheet" href="css/combined-abilities.css" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="css/combined-abilities.css"></noscript>

    <link rel="stylesheet" href="css/statistics.css">
    <link rel="stylesheet" href="css/farmer_cham_cham.css">
    <link rel="stylesheet" href="css/schoolboy_shoma-ball-vfx.css">
    <link rel="stylesheet" href="css/ayane-abilities.css">
    <link rel="stylesheet" href="styles/farmer_nina.css">
    <link rel="stylesheet" href="css/atlantean_kagome_abilities.css">
    <link rel="stylesheet" href="css/atlantean_kotal_kahn_abilities.css">
    <link rel="stylesheet" href="css/atlantean_zasalamel_abilities.css">
    <link rel="stylesheet" href="css/atlantean_shinnok_abilities.css">
    <link rel="stylesheet" href="css/raid-game/vfx/atlantean_kagome_vfx.css">
    <link rel="stylesheet" href="css/raid-game/vfx/shadowfin_abilities.css">
    <link rel="stylesheet" href="css/loot-rewards.css">
    <link rel="stylesheet" href="css/farmer_alice_abilities.css">
    <link rel="stylesheet" href="css/farmer_shoma_abilities.css">
    <link rel="stylesheet" href="css/schoolgirl_kokoro_abilities.css">
    <link rel="stylesheet" href="css/schoolgirl_kokoro_holy.css">
    <link rel="stylesheet" href="css/schoolboy_siegfried_abilities.css">
    <link rel="stylesheet" href="css/schoolgirl_julia_abilities.css">
    <link rel="stylesheet" href="css/schoolgirl_ayane_abilities.css">
    <link rel="stylesheet" href="css/butterfly_talents_vfx.css">
    <link rel="stylesheet" href="css/schoolgirl_elphelt_abilities.css">
    <link rel="stylesheet" href="css/infernal_astaroth_abilities.css">
    <link rel="stylesheet" href="css/infernal_scorpion.css">
    <link rel="stylesheet" href="css/infernal_birdie_abilities.css">
    <link rel="stylesheet" href="css/infernal_ibuki_abilities.css">
    <link rel="stylesheet" href="css/infernal_raiden_abilities.css">
    <link rel="stylesheet" href="css/angry_carrot_abilities.css">
    <link rel="stylesheet" href="css/farmer_raiden_abilities.css">
    <link rel="stylesheet" href="css/farmer_cham_cham_talents.css">
    <link rel="stylesheet" href="css/angry_pig_abilities.css">
    <link rel="stylesheet" href="css/angry_chicken_abilities.css">
    <link rel="stylesheet" href="css/angry_bull_abilities.css">
    <link rel="stylesheet" href="css/monster_apple_passive.css">
    <link rel="stylesheet" href="css/healthy_apple_passive.css">
    <link rel="stylesheet" href="css/angry_apple_passive.css">
    <link rel="stylesheet" href="css/leafy_apple_passive.css">
    <link rel="stylesheet" href="css/rotten_apple_passive.css">
    <link rel="stylesheet" href="css/apple_abilities.css">
    <link rel="stylesheet" href="css/crazy_farmer_abilities.css">
    <link rel="stylesheet" href="css/hound_abilities.css">
    <link rel="stylesheet" href="css/scarecrow_abilities.css">
    <link rel="stylesheet" href="css/farmer_fang_abilities.css">
    <link rel="stylesheet" href="css/controller-support.css">
    <link rel="stylesheet" href="css/bridget.css">
    <link rel="stylesheet" href="css/bridget_abilities.css">
    <link rel="stylesheet" href="css/ren√©e.css">
    <link rel="stylesheet" href="css/zoey.css">
    <link rel="stylesheet" href="css/xp-rewards.css">
    <link rel="stylesheet" href="css/stage-modifiers.css">
    <link rel="stylesheet" href="css/scamp_passive.css">
    <link rel="stylesheet" href="css/shadow_assassin_female_abilities.css">
    <link rel="stylesheet" href="css/shadow_assassin_abilities.css">
    <link rel="stylesheet" href="css/assassin_stealth_abilities.css">
    <link rel="stylesheet" href="css/octopus_assassin_abilities.css">
    <link rel="stylesheet" href="css/scamp_abilities.css">
    <link rel="stylesheet" href="css/raid-game/passives/shadowfin_passive.css">
    <link rel="stylesheet" href="css/raid-game/passives/atlantean_christie_passive.css">
    <link rel="stylesheet" href="css/raid-game/vfx/shadowfin_abilities.css">
    <link rel="stylesheet" href="css/raid-game/vfx/lava_chimp_passive.css">
    <link rel="stylesheet" href="css/raid-game/vfx/smith_lord_abilities.css">
    <link rel="stylesheet" href="css/raid-game/vfx/dual-shot-vfx.css">
    <link rel="stylesheet" href="css/raid-game/vfx/trickshot-vfx.css">
    <link rel="stylesheet" href="css/raid-game/vfx/acid_lava_spit.css">
    <link rel="stylesheet" href="css/raid-game/vfx/ice_ball_vfx.css">
    <link rel="stylesheet" href="css/raid-game/vfx/hellboar_charge.css">
    <link rel="stylesheet" href="css/raid-game/vfx/cursed_lion_abilities.css">
    <link rel="stylesheet" href="css/raid-game/vfx/hell_fly_double_scissor.css">
    <link rel="stylesheet" href="css/vulgrim_abilities.css">
    <link rel="stylesheet" href="css/raid-game/vfx/armor_shredding.css">
    <link rel="stylesheet" href="css/raid-game/vfx/gargolyan_taunt.css">
    <link rel="stylesheet" href="css/raid-game/vfx/gargolyan_magma_pulse.css">
    <link rel="stylesheet" href="css/raid-game/vfx/hellhorn_tackle.css">
    <link rel="stylesheet" href="css/raid-game/vfx/hellhorn_stomp.css">
    <link rel="stylesheet" href="css/raid-game/vfx/unstoppable_passive.css">
    <link rel="stylesheet" href="css/raid-game/vfx/kroudin_punishment.css">
    <link rel="stylesheet" href="css/raid-game/vfx/freezing_waters.css">
    <link rel="stylesheet" href="css/atlantean_christie_abilities.css">
    <link rel="stylesheet" href="css/raid-game/vfx/abyssal_smash.css">
    <link rel="stylesheet" href="css/raid-game/vfx/tidal_splash.css">
    <link rel="stylesheet" href="css/raid-game/vfx/abyssal_regen.css">
    <link rel="stylesheet" href="css/raid-game/vfx/maul.css">
    <link rel="stylesheet" href="css/raid-game/passives/atlantean_kagome_passive.css">
    <link rel="stylesheet" href="css/raid-game/vfx/necromatic_characters_vfx.css">
    <link rel="stylesheet" href="css/raid-game/passives/talking_necromatic_tree_passive.css">
    <!-- Special battle log color for talents and unique effects -->
    <link rel="stylesheet" href="css/special-battlelog.css">
    
    <!-- Quest Completion Styles -->
    <style>
        /* Quest Completion Notification */
        .quest-completion-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #5463ff, #ff6b6b);
            color: white;
            padding: 20px 25px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transform: translateX(400px);
            opacity: 0;
            transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 1100;
            max-width: 380px;
            min-width: 320px;
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .quest-completion-notification.show {
            transform: translateX(0);
            opacity: 1;
        }
        
        .quest-completion-notification::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(to right, #ffbd00, #ff8c00);
            border-radius: 12px 12px 0 0;
        }
        
        .quest-completion-content {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .quest-completion-icon {
            font-size: 2.5rem;
            background: rgba(255, 255, 255, 0.15);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: questPulse 2s ease-in-out infinite;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        @keyframes questPulse {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.4);
            }
            50% { 
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(255, 255, 255, 0);
            }
        }
        
        .quest-completion-text {
            flex: 1;
            min-width: 0;
        }
        
        .quest-completion-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 6px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        .quest-completion-name {
            font-size: 1rem;
            margin-bottom: 4px;
            opacity: 0.95;
            font-weight: 600;
        }
        
        .quest-completion-reward {
            font-size: 0.85rem;
            opacity: 0.85;
            font-weight: 500;
        }
        
        .quest-completion-progress {
            margin-top: 8px;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
        }
        
        /* Multiple Quest Notifications */
        .quest-completion-notification:nth-child(2) {
            top: 130px;
            animation-delay: 0.2s;
        }
        
        .quest-completion-notification:nth-child(3) {
            top: 240px;
            animation-delay: 0.4s;
        }
        
        .quest-completion-notification:nth-child(4) {
            top: 350px;
            animation-delay: 0.6s;
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .quest-completion-notification {
                right: 10px;
                left: 10px;
                max-width: none;
                min-width: auto;
                padding: 16px 20px;
                transform: translateY(-100px);
            }
            
            .quest-completion-notification.show {
                transform: translateY(0);
            }
            
            .quest-completion-content {
                gap: 12px;
            }
            
            .quest-completion-icon {
                width: 50px;
                height: 50px;
                font-size: 2rem;
            }
            
            .quest-completion-title {
                font-size: 1.1rem;
            }
            
            .quest-completion-name {
                font-size: 0.95rem;
            }
            
            .quest-completion-reward {
                font-size: 0.8rem;
            }
        }
        
        /* Stun Break VFX Styles */
        .stun-break-vfx {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .stun-break-text {
            position: absolute;
            top: 30%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.2rem;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            animation: stunBreakTextAnim 2s ease-out forwards;
            z-index: 101;
        }
        
        @keyframes stunBreakTextAnim {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }
            30% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.2);
            }
            70% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }
        }
        
        .stun-break-particle {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 8px;
            height: 8px;
            background: radial-gradient(circle, #FFD700, #FFA500);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: stunBreakParticleAnim 1.5s ease-out forwards var(--delay, 0s);
        }
        
        @keyframes stunBreakParticleAnim {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0);
            }
            20% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
            100% {
                opacity: 0;
                transform: 
                    translate(-50%, -50%) 
                    translate(calc(cos(var(--angle)) * 60px), calc(sin(var(--angle)) * 60px)) 
                    scale(0.5);
            }
        }
        
        /* Quest Progress Notification (for smaller updates) */
        .quest-progress-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(84, 99, 255, 0.9);
            color: white;
            padding: 12px 18px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            transform: translateX(300px);
            opacity: 0;
            transition: all 0.4s ease;
            z-index: 1050;
            -webkit-backdrop-filter: blur(5px);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .quest-progress-notification.show {
            transform: translateX(0);
            opacity: 1;
        }
        
        @media (max-width: 768px) {
            .quest-progress-notification {
                bottom: 10px;
                right: 10px;
                left: 10px;
                text-align: center;
                transform: translateY(100px);
            }
            
            .quest-progress-notification.show {
                                 transform: translateY(0);
             }
         }
         
         /* Quest completion log entry styling */
         .log-entry.quest-complete {
             background: linear-gradient(135deg, rgba(84, 99, 255, 0.2), rgba(255, 107, 107, 0.2));
             border-left: 4px solid #ffbd00;
             color: #fff;
             font-weight: 600;
             animation: questGlow 2s ease-in-out;
         }
         
         @keyframes questGlow {
             0%, 100% { 
                 box-shadow: 0 0 5px rgba(255, 189, 0, 0.3);
             }
             50% { 
                 box-shadow: 0 0 20px rgba(255, 189, 0, 0.6);
             }
         }
    </style>
</head>
<body class="raid-game-context">
    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen">
        <div class="loader"></div>
        <div id="loading-text" class="loading-text">Loading Game...</div>
    </div>

    <!-- Talents Side Panel -->
    <div id="talents-panel" class="talents-panel">
        <div class="talents-panel-header">
            <h2>Active Talents</h2>
            <button id="toggle-talents-panel" class="toggle-talents-panel" title="Hide talents">‚óÄ</button>
        </div>
        <div class="talents-panel-content">
            <div id="talents-characters-list" class="talents-characters-list">
                <!-- Character talents will be dynamically loaded here -->
            </div>
        </div>
    </div>

    <!-- Statistics Panel -->
    <div id="statistics-panel" class="statistics-panel">
        <div class="statistics-panel-header">
            <h2>Battle Statistics</h2>
            <button id="toggle-statistics-panel" class="toggle-statistics-panel" title="Hide statistics">‚óÄ</button>
        </div>
        <div class="statistics-panel-content">
            <div class="statistics-tabs">
                <button class="statistics-tab active" data-tab="overview">Overview</button>
                <button class="statistics-tab" data-tab="damage">Damage</button>
                <button class="statistics-tab" data-tab="healing">Healing</button>
                <button class="statistics-tab" data-tab="combat">Combat</button>
                <button class="statistics-tab" data-tab="abilities">Abilities</button>
            </div>
            <div class="statistics-content">
                <div id="statistics-overview" class="statistics-tab-content active">
                    <!-- Overview content will be loaded here -->
                </div>
                <div id="statistics-damage" class="statistics-tab-content">
                    <!-- Damage statistics will be loaded here -->
                </div>
                <div id="statistics-healing" class="statistics-tab-content">
                    <!-- Healing statistics will be loaded here -->
                </div>
                <div id="statistics-combat" class="statistics-tab-content">
                    <!-- Combat statistics (dodges, crits) will be loaded here -->
                </div>
                <div id="statistics-abilities" class="statistics-tab-content">
                    <!-- Ability statistics will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <div class="battle-container">
        <!-- Show Talents Button (only visible when panel is hidden) -->
        <button id="show-talents-button" class="show-talents-button" title="Show talents">‚ñ∂</button>
        
        <!-- Show Statistics Button (only visible when panel is hidden) -->
        <button id="show-statistics-button" class="show-statistics-button" title="Show statistics">üìä</button>
        
        <!-- Stage Background -->
        <div id="stage-background" class="stage-background"></div>
        
        <!-- Stage Modifiers UI -->
        <div id="stage-modifiers-container" class="stage-modifiers-container" style="display: none;">
            <div class="stage-modifiers-heading">Stage Effects</div>
            <div id="stage-modifiers-list" class="stage-modifiers-list">
                <!-- Stage modifiers will be dynamically populated here -->
            </div>
        </div>
        
        <!-- Volume Control -->
        <div class="volume-control" id="volume-control">
            <span class="volume-icon" id="volume-icon">üîä</span>
            <input type="range" class="volume-slider" id="volume-slider" min="0" max="100" value="70" aria-label="Volume Control">
        </div>

        <!-- Quest Panel Toggle Button -->
        <button class="quest-panel-toggle" id="quest-panel-toggle" title="Toggle Quest Panel (SHIFT key)">
            üéØ Quests
        </button>

        <!-- Quests Panel -->
        <div class="quests-panel" id="quests-panel" style="display: none;">
            <div class="quests-panel-header">
                <!-- Drag handle and close button will be added by JavaScript -->
                <h3>üéØ Character Quests</h3>
                <button class="toggle-quests-button" id="toggle-quests-button">‚ñº</button>
            </div>
            <div class="quests-panel-content" id="quests-panel-content">
                <div class="quests-loading" id="quests-loading">
                    <p>Loading quests...</p>
                </div>
                <div class="quests-list" id="quests-list"></div>
                <div class="quests-empty" id="quests-empty" style="display: none;">
                    <p>No active quests for selected character</p>
                </div>
            </div>
        </div>
        
        <!-- AI Section (Top) -->
        <div class="top-section">
            <div id="ai-characters-container" class="characters-container">
                <!-- AI characters will be dynamically loaded here -->
            </div>
        </div>

        <!-- Middle Section with Turn Counter -->
        <div class="middle-section">
            <button id="end-turn-button" class="end-turn-button">End Turn</button>
            <div id="battle-phase">Player's Turn</div>
            <div class="turn-counter">Turn: <span id="turn-count">1</span></div>
        </div>

        <!-- Player Section (Bottom) -->
        <div class="bottom-section">
            <div id="player-characters-container" class="characters-container">
                <!-- Player characters will be dynamically loaded here -->
            </div>
        </div>

        <!-- Battle Log -->
        <div class="battle-log-container" id="battle-log-container">
            <div class="battle-log-header" id="battle-log-header">
                <div class="battle-log-drag-handle" id="battle-log-drag-handle">
                    <span class="battle-log-title">‚öîÔ∏è Battle Log</span>
                </div>
                <div class="battle-log-controls">
                    <button id="toggle-reduction-messages-button" class="log-button" title="Toggle armor/shield reduction messages">üõ°Ô∏è</button>
                    <button id="clear-log-button" class="log-button" title="Clear log">üóëÔ∏è</button>
                    <button id="toggle-log-button" class="log-button" title="Toggle log size">‚¨ç</button>
                    <button id="close-log-button" class="log-button" title="Close battle log">‚úï</button>
                </div>
            </div>
            <div class="battle-log-content">
                <div id="battle-log" class="battle-log">
                    <!-- Battle log entries will be added here -->
                </div>
            </div>
        </div>

        <!-- Battle Log Toggle Button (shown when log is closed) -->
        <button id="show-log-button" class="show-log-button" title="Show battle log" style="display: none;">
            üìã Log
        </button>

        <!-- Game Over Screen (Hidden by default) -->
        <div id="game-over-container" class="game-over-container">
            <div class="game-over-content">
                <h2 id="game-over-title" class="game-over-title">Victory!</h2>
                <p id="game-over-message" class="game-over-message">You have defeated all enemies!</p>
                <div class="game-over-buttons">
                    <button id="character-select-button" class="game-over-button">Character Select</button>
                    <button id="restart-button" class="game-over-button">Restart Battle</button>
                </div>
            </div>
        </div>

        <!-- Tooltip (Hidden by default) -->
        <div id="tooltip" class="tooltip">
            <div id="tooltip-title" class="tooltip-title"></div>
            <div id="tooltip-description" class="tooltip-description"></div>
        </div>

        <!-- Context Menu (Hidden by default) -->
        <div id="context-menu" class="context-menu">
            <!-- Context menu items will be dynamically populated -->
        </div>

        <!-- Quick Action Bar -->
        <div id="quick-action-bar" class="quick-action-bar">
            <button id="qab-quests" class="quick-action-btn" title="Toggle Quests">üéØ</button>
            <button id="qab-talents" class="quick-action-btn" title="Toggle Talents">‚≠ê</button>
            <button id="qab-log" class="quick-action-btn" title="Toggle Battle Log">üìã</button>
            <button id="qab-stats" class="quick-action-btn" title="Toggle Statistics">üìä</button>
            <button id="qab-inventory" class="quick-action-btn" title="Global Inventory">üéí</button>
            <button id="qab-consumables" class="quick-action-btn" title="Consumable Items">üß™</button>
        </div>
    </div>

    <!-- Tutorial System -->
    <script src="js/raid-game/tutorial-manager.js"></script>
    <link rel="stylesheet" href="css/tutorial.css">

    <!-- VFX Systems -->
    <script src="js/raid-game/vfx/healing-wind-vfx.js"></script>
    <link rel="stylesheet" href="css/styles/vfx.css">

    <!-- Game Scripts -->
    <!-- Core Classes -->
    <script src="js/raid-game/stage-modifiers.js"></script>
    <script src="js/raid-game/character.js"></script>
    <script src="js/raid-game/character-xp-manager.js"></script>
    <script src="js/raid-game/ability-modifier.js"></script>
    <script src="js/raid-game/talent-manager.js"></script>
    <script src="js/raid-game/talent-modifiers/infernal_ibuki_talent_modifier.js"></script>
    
    <!-- Inventory System Scripts -->
    <script src="js/raid-game/item-system.js"></script>
    <script src="js/raid-game/inventory-integration.js"></script>
    <script src="js/raid-game/inventory-ui-manager.js"></script>
    <script type="module" src="items/game-integration.js"></script>
    
    <!-- Loot System Scripts -->
    <script src="js/raid-game/loot-manager.js"></script>
    <script src="js/raid-game/loot-ui-manager.js"></script>
    
    <!-- Inventory System CSS -->
    <link rel="stylesheet" href="css/inventory-system.css">
    
    <!-- Skin System Scripts -->
    <script src="js/skins/skin-registry.js"></script>
    <script src="js/skins/skin-manager.js"></script>
    <script src="js/skins/skin-vfx-manager.js"></script>
    <script src="js/raid-game/passive-factory.js"></script>
    <script src="js/raid-game/statistics-manager.js"></script>
    <script src="js/raid-game/quest-manager.js"></script>
    <script src="js/raid-game/quest-ui-manager.js"></script>

    <!-- ALL Passive Ability Scripts (Load AFTER PassiveFactory, BEFORE Managers) -->
    <script src="js/raid-game/passives/schoolboy_siegfried_passive.js"></script>
    <script src="js/raid-game/passives/schoolgirl_julia_passive.js"></script>
    <script src="js/raid-game/passives/schoolgirl_ayane_passive.js"></script>
    <script src="js/raid-game/passives/schoolgirl_elphelt_passive.js"></script>
    <script src="js/raid-game/passives/infernal_astaroth_passive.js"></script>
    <script src="js/raid-game/passives/infernal_scorpion_passive.js"></script>
    <script src="js/raid-game/passives/infernal_birdie_passive.js"></script>
    <script src="js/raid-game/passives/farmer_cham_cham_passive.js"></script>
    <script src="js/raid-game/passives/farmer_raiden_passive.js"></script>
    <script src="js/raid-game/passives/angry_pig_passive.js"></script>
    <script src="js/raid-game/passives/angry_chicken_passive.js"></script>
    <script src="js/raid-game/passives/angry_bull_passive.js"></script>
    <script src="js/raid-game/passives/monster_apple_passive.js"></script>
    <script src="js/raid-game/passives/healthy_apple_passive.js"></script>
    <script src="js/raid-game/passives/angry_apple_passive.js"></script>
    <script src="js/raid-game/passives/leafy_apple_passive.js"></script>
    <script src="js/raid-game/passives/rotten_apple_passive.js"></script>
    <script src="js/raid-game/passives/crazy_farmer_passive.js"></script>
    <script src="js/raid-game/passives/hound_passive.js"></script>
    <script src="js/raid-game/passives/farmer_fang_passive.js"></script>
    <script src="js/raid-game/passives/bridget_passive.js"></script>
    <script src="js/raid-game/passives/ren√©e_passive.js"></script>
    <script src="js/raid-game/passives/zoey_passive.js"></script>
    <script src="js/raid-game/passives/little_devil_passive.js"></script>
    <script src="js/raid-game/passives/scamp_passive.js"></script>
    <script src="js/raid-game/passives/piranha_passive.js"></script>
    <script src="js/raid-game/passives/shadowfin_passive.js"></script>
    <script src="js/raid-game/passives/atlantean_christie_passive.js"></script>
    <script src="js/raid-game/passives/grok_hell_lord_passive.js"></script>
    <script src="js/raid-game/passives/lava_chimp_passive.js"></script>
    <script src="js/raid-game/passives/smith_lord_passive.js"></script>
    <script src="js/raid-game/passives/hotshot_diablo_passive.js"></script>
    <script src="js/raid-game/passives/hotshot_diabla_passive.js"></script>
    <script src="js/raid-game/passives/unstoppable_passive.js"></script>
    <script src="js/raid-game/passives/atlantean_kotal_kahn_passive.js"></script>
    <script src="js/raid-game/passives/atlantean_shinnok_passive.js"></script>
    <script src="js/raid-game/passives/atlantean_kagome_passive.js"></script>
    <!-- Add other passive scripts here -->

    <!-- Factories -->
    <script src="js/raid-game/character/character-service.js"></script>
    <!-- <script src="js/raid-game/character-factory.js"></script> -->
    <!-- NOTE: CharacterFactory logic seems integrated into character.js now -->

    <!-- Controller Support -->
    <script src="js/raid-game/controller-manager.js"></script>
    

    <!-- Weekly Challenge AI -->
    <script src="js/raid-game/weekly-challenge-ai.js"></script>

    <!-- Managers (Depend on Factories and Passives being registered) -->
    <script src="js/raid-game/stage-manager.js"></script>
    <script src="js/raid-game/game-manager.js"></script>
    <script src="js/raid-game/statistics-ui-manager.js"></script>

    <!-- Character/Ability Specific Scripts (Load AFTER core classes/managers) -->
    <script src="js/raid-game/characters/schoolboy_shoma-ball-selection.js"></script>
    <script src="js/raid-game/abilities/schoolboy_shoma-homerun.js"></script>
    <script src="js/raid-game/abilities/schoolboy_shoma_abilities.js"></script>
    <script src="js/raid-game/abilities/cham_cham_abilities.js"></script>
    <script src="js/raid-game/abilities/farmer_cham_cham_abilities.js"></script>
    <script src="js/raid-game/abilities/ayane_abilities.js"></script>
    <script src="js/raid-game/abilities/farmer_nina_abilities.js"></script>
    <script src="js/raid-game/abilities/atlantean_kagome_abilities.js"></script>
    <script src="js/raid-game/abilities/atlantean_kotal_kahn_abilities.js"></script>
    <script src="js/raid-game/abilities/atlantean_zasalamel_abilities.js"></script>
    <script src="js/raid-game/abilities/atlantean_shinnok_abilities.js"></script>
    <script src="js/raid-game/abilities/atlantean_christie_abilities.js"></script>
    <script src="js/raid-game/abilities/dark_leviathan_abilities.js"></script>
<script src="js/raid-game/abilities/atlantean_sub_zero_abilities.js"></script>
    <script src="js/raid-game/abilities/shadowfin_abilities.js"></script>
    <script src="js/raid-game/abilities/farmer_alice_abilities.js"></script>
    <script src="js/raid-game/abilities/farmer_shoma_abilities.js"></script>
    <script src="js/raid-game/abilities/schoolgirl_kokoro_abilities.js"></script>
    <script src="js/raid-game/abilities/schoolboy_siegfried_abilities.js"></script>
    <script src="js/raid-game/abilities/schoolgirl_julia_abilities.js"></script>
    <script src="js/raid-game/abilities/schoolgirl_ayane_abilities.js"></script>
    <script src="js/raid-game/abilities/schoolgirl_elphelt_abilities.js"></script>
    <script src="js/raid-game/abilities/infernal_astaroth_abilities.js"></script>
    <script src="js/raid-game/abilities/infernal_scorpion_abilities.js"></script>
    <script src="js/raid-game/abilities/blazing_elemental_abilities.js"></script>
    <script src="js/raid-game/abilities/infernal_birdie_abilities.js"></script>
    <script src="js/raid-game/abilities/infernal_ibuki_abilities.js"></script>
    <script src="js/raid-game/abilities/infernal_raiden_abilities.js"></script>
    <script src="js/raid-game/abilities/angry_carrot_abilities.js"></script>
    <script src="js/raid-game/abilities/farmer_raiden_abilities.js"></script>
    <script src="js/raid-game/abilities/angry_pig_pitchfork_pierce.js"></script>
    <script src="js/raid-game/abilities/angry_chicken_double_stab.js"></script>
    <script src="js/raid-game/abilities/angry_bull_horn_drill.js"></script>
    <script src="js/raid-game/abilities/apple_abilities.js"></script>
    <script src="js/raid-game/abilities/crazy_farmer_abilities.js"></script>
    <script src="js/raid-game/abilities/hound_abilities.js"></script>
    <script src="js/raid-game/abilities/scarecrow_abilities.js"></script>
    <script src="js/raid-game/abilities/crow_abilities.js"></script>
    <script src="js/raid-game/abilities/farmer_fang_abilities.js"></script>
    <script src="js/raid-game/abilities/target_dummy_abilities.js"></script>
    <script src="js/raid-game/abilities/bridget_abilities.js"></script>
    <script src="js/raid-game/abilities/ren√©e_abilities.js"></script>
    <script src="js/raid-game/abilities/renee_abilities_stats.js"></script>
    <script src="js/raid-game/abilities/zoey_abilities.js"></script>
    <script src="js/raid-game/abilities/little_devil_abilities.js"></script>
    <script src="js/raid-game/abilities/morissa_abilities.js"></script>
    <script src="js/raid-game/abilities/scamp_abilities.js"></script>
    <script src="js/raid-game/abilities/lava_chimp_abilities.js"></script>
    <script src="js/raid-game/abilities/smith_lord_abilities.js"></script>
    <script src="js/raid-game/abilities/vulgrim_abilities.js"></script>
    <script src="js/raid-game/abilities/cursed_lion_abilities.js"></script>
    <script src="js/raid-game/abilities/lava_worm_abilities.js"></script>
    <script src="js/raid-game/abilities/hotshot_dual_shot_abilities.js"></script>
    <script src="js/raid-game/abilities/hell_fly_abilities.js"></script>
    <script src="js/raid-game/abilities/gargolyan_abilities.js"></script>
    <script src="js/raid-game/abilities/hellhorn_abilities.js"></script>
    <script src="js/raid-game/abilities/kroudin_abilities.js"></script>
    <script src="js/raid-game/abilities/grok_hell_lord_abilities.js"></script>
    <script src="js/raid-game/abilities/reptilian_assassin_abilities.js"></script>
    <script src="js/raid-game/abilities/shadow_assassin_abilities.js"></script>
    <script src="js/raid-game/abilities/assassin_stealth_abilities.js"></script>
    <script src="js/raid-game/abilities/octopus_assassin_abilities.js"></script>
    <script src="js/raid-game/abilities/talking_necromatic_tree_abilities.js"></script>
    <script src="js/raid-game/abilities/necromatic_corrupted_bear_abilities.js"></script>
    <script src="js/raid-game/vfx/necromatic_characters_vfx.js"></script>

    <!-- Firebase JS SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-database-compat.js"></script>

    <!-- Firebase Config -->
    <script src="js/firebase-config.js"></script>

    <!-- Talents Panel Script -->
    <script src="js/raid-game/talents-panel.js"></script>

    <script src="js/raid-game/passives/atlantean_sub_zero_passive.js"></script>
    <script src="js/raid-game/passives/atlantean_zasalamel_passive.js"></script>
    <script src="js/raid-game/passives/talking_necromatic_tree_passive.js"></script>

    <script>
        // Function to hide loading screen
        function hideLoadingScreen() {
            const loadingScreen = document.getElementById('loading-screen');
            loadingScreen.style.opacity = '0';
            loadingScreen.style.transition = 'opacity 0.5s';
            setTimeout(() => {
                loadingScreen.style.display = 'none';
            }, 500);
        }

        // Global function for updating character UI (needed by character.js)
        function updateCharacterUI(character) {
            if (window.gameManager && window.gameManager.uiManager) {
                window.gameManager.uiManager.updateCharacterUI(character);
            }
        }

        // Global function for adding log entries (needed by character.js)
        function addLogEntry(message, className = '') {
            if (window.gameManager) {
                window.gameManager.addLogEntry(message, className);
            } else {
                console.log(message);
            }
        }

        // Setup tooltip functionality
        function setupTooltip() {
            const tooltip = document.getElementById('tooltip');
            const tooltipTitle = document.getElementById('tooltip-title');
            const tooltipDescription = document.getElementById('tooltip-description');
            
            // Show tooltip
            function showTooltip(title, description, x, y) {
                tooltipTitle.textContent = title;
                tooltipDescription.innerHTML = description;
                
                // Set initial position but temporarily make invisible to calculate dimensions
                tooltip.style.visibility = 'hidden';
                tooltip.style.left = `${x}px`;
                tooltip.style.top = `${y}px`;
                tooltip.classList.add('visible');
                
                // Calculate dimensions and adjust position if needed
                const tooltipRect = tooltip.getBoundingClientRect();
                const tooltipWidth = tooltipRect.width;
                const tooltipHeight = tooltipRect.height;
                const windowWidth = window.innerWidth;
                const windowHeight = window.innerHeight;
                
                // Check if tooltip would go outside window and adjust position
                let finalX = x;
                let finalY = y;
                
                // Check right edge
                if (x + tooltipWidth > windowWidth) {
                    finalX = x - tooltipWidth - 10; // 10px spacing from the source element
                }
                
                // Check bottom edge
                if (y + tooltipHeight > windowHeight) {
                    finalY = y - tooltipHeight + 20; // Adjust position to appear above cursor
                    if (finalY < 0) {
                        // If it would go outside top edge, put it at the top with margin
                        finalY = 10;
                    }
                }
                
                // Apply final position
                tooltip.style.left = `${finalX}px`;
                tooltip.style.top = `${finalY}px`;
                tooltip.style.visibility = 'visible';
            }
            
            // Hide tooltip
            function hideTooltip() {
                tooltip.classList.remove('visible');
            }
            
            // Add mouseover event to ability elements
            document.addEventListener('mouseover', (e) => {
                const abilityElement = e.target.closest('.ability');
                if (abilityElement) {
                    // Find character and ability info
                    const characterElement = abilityElement.closest('.character-slot');
                    if (characterElement) {
                        // Use instanceId from dataset for unique identification
                        const instanceId = characterElement.dataset.instanceId; 
                        const abilityIndex = abilityElement.dataset.index;
                        
                        // Get character from game state using instanceId if it exists
                        let character = null;
                        if (window.gameManager && instanceId) { 
                            character = window.gameManager.gameState.playerCharacters.find(c => (c.instanceId || c.id) === instanceId);
                            if (!character) {
                                // Check AI characters using instanceId
                                character = window.gameManager.gameState.aiCharacters.find(c => c.instanceId === instanceId);
                            }
                        }
                        
                        if (character && abilityIndex !== undefined) {
                            const ability = character.abilities[abilityIndex];
                            if (ability) {
                                const rect = abilityElement.getBoundingClientRect();
                                showTooltip(
                                    ability.name,
                                    ability.description,
                                    rect.right + 10,
                                    rect.top
                                );
                            }
                        }
                    }
                }
                
                // Add tooltip for Alice's Magic Shield counter
                const shieldCounter = e.target.closest('.magic-shield-counter');
                if (shieldCounter) {
                    const characterElement = shieldCounter.closest('.character-slot');
                    if (characterElement) {
                        const characterId = characterElement.id.replace('character-', '');
                        
                        // Get character from game state
                        let character = null;
                        if (window.gameManager) {
                            character = window.gameManager.gameState.playerCharacters.find(c => c.id === characterId);
                            if (!character) {
                                character = window.gameManager.gameState.aiCharacters.find(c => c.id === characterId);
                            }
                        }
                        
                        if (character && character.passive) {
                            const rect = shieldCounter.getBoundingClientRect();
                            const passiveDesc = character.passive.description + 
                                   `\n\nTotal Magic Shield gained from passive: ${character.magicShieldFromPassive}`;
                            showTooltip(
                                character.passive.name,
                                passiveDesc,
                                rect.right + 10,
                                rect.top
                            );
                        }
                    }
                }
                
                // Add tooltip for talent items in the talent panel
                const talentItem = e.target.closest('.talent-item');
                if (talentItem && talentItem.dataset.talentId) {
                    const talentId = talentItem.dataset.talentId;
                    const talentName = talentItem.dataset.talentName;
                    const talentDescription = talentItem.dataset.talentDescription;
                    
                    if (talentName && talentDescription) {
                        const rect = talentItem.getBoundingClientRect();
                        showTooltip(
                            talentName,
                            talentDescription,
                            rect.right + 10,
                            rect.top
                        );
                    }
                }
            });
            
            // Add mouseout event to hide tooltip
            document.addEventListener('mouseout', (e) => {
                if (e.target.closest('.ability') || e.target.closest('.magic-shield-counter') || e.target.closest('.talent-item')) {
                    hideTooltip();
                }
            });
        }

        // Setup game over screen functionality
        function setupGameOverScreen() {
            const gameOverContainer = document.getElementById('game-over-container');
            const gameOverTitle = document.getElementById('game-over-title');
            const gameOverMessage = document.getElementById('game-over-message');
            const restartButton = document.getElementById('restart-button');
            const characterSelectButton = document.getElementById('character-select-button');
            
            // Show game over screen
            window.showGameOverScreen = function(isVictory) {
                console.log(`[raid-game.html] showGameOverScreen called with isVictory: ${isVictory}`); // Log function call
                const urlParams = new URLSearchParams(window.location.search);
                const returnUrl = urlParams.get('returnUrl');
                const isInStoryMode = !!returnUrl; // Check if we are in story mode context

                if (isVictory) {
                    gameOverTitle.textContent = 'Victory!';
                    gameOverTitle.className = 'game-over-title victory';
                    gameOverMessage.textContent = 'You have defeated all enemies!';

                    // Show restart button (optional for victory, maybe hide in story mode?)
                    restartButton.style.display = 'inline-block'; // Or 'none' if you want to hide it on story victory too

                    // Handle the other button based on story mode
                    if (isInStoryMode) {
                        characterSelectButton.textContent = "Continue Story";
                        characterSelectButton.onclick = () => {
                            window.location.href = returnUrl; // Use the provided return URL
                        };
                    } else {
                        characterSelectButton.textContent = "Character Select";
                        characterSelectButton.onclick = () => {
                            window.location.href = 'character-selector.html';
                        };
                    }
                    characterSelectButton.style.display = 'inline-block'; // Ensure it's visible

                } else { // Defeat
                    gameOverTitle.textContent = 'Defeat!';
                    gameOverTitle.className = 'game-over-title defeat';
                    gameOverMessage.textContent = 'Your team has been defeated!';

                    // Hide the restart button on defeat
                    restartButton.style.display = 'none';

                    // Always show the "Character Select" button on defeat and make it go back
                    characterSelectButton.textContent = "Character Select";
                    characterSelectButton.onclick = () => {
                        window.location.href = 'character-selector.html';
                    };
                    characterSelectButton.style.display = 'inline-block'; // Ensure it's visible
                }

                gameOverContainer.classList.add('active');
            };

            // Hide game over screen
            window.hideGameOverScreen = function() {
                gameOverContainer.classList.remove('active');
            };

            // Restart game button (only shown on victory now, or non-story defeat)
            restartButton.addEventListener('click', () => {
                hideGameOverScreen();
                if (window.gameManager) {
                    const selectedStage = localStorage.getItem('selectedStage');
                    if (selectedStage) {
                        try {
                            const stageData = JSON.parse(selectedStage);
                            window.gameManager.startGame(stageData.id);
                        } catch (e) {
                             console.error("Error parsing selected stage from localStorage:", e);
                             window.gameManager.startGame('test_stage'); // Fallback
                        }
                    } else {
                        window.gameManager.startGame('test_stage'); // Fallback
                    }
                }
            });

            // Character select button (behavior is set dynamically in showGameOverScreen)
            // No default listener needed here anymore, as onclick is set above.
            // characterSelectButton.addEventListener('click', () => {
            //     window.location.href = 'character-selector.html';
            // });
        }

        // Setup battle log controls
        function setupBattleLog() {
            console.log('[setupBattleLog] Initializing battle log...');
            
            const battleLogContainer = document.getElementById('battle-log-container');
            const battleLogHeader = document.getElementById('battle-log-header');
            const dragHandle = document.getElementById('battle-log-drag-handle');
            const toggleReductionMessagesButton = document.getElementById('toggle-reduction-messages-button');
            const toggleLogButton = document.getElementById('toggle-log-button');
            const clearLogButton = document.getElementById('clear-log-button');
            const closeLogButton = document.getElementById('close-log-button');
            const showLogButton = document.getElementById('show-log-button');
            
            if (!battleLogContainer) {
                console.error('[setupBattleLog] Battle log container not found!');
                return;
            }
            
            console.log('[setupBattleLog] Battle log elements found, setting up...');
            
            // FORCE BATTLE LOG TO BE VISIBLE - Reset any hidden state
            battleLogContainer.style.display = 'flex';
            battleLogContainer.style.visibility = 'visible';
            battleLogContainer.style.opacity = '1';
            battleLogContainer.style.zIndex = '1000';
            battleLogContainer.style.position = 'fixed';
            battleLogContainer.style.right = '20px';
            battleLogContainer.style.bottom = '20px';
            battleLogContainer.style.left = 'auto';
            battleLogContainer.style.top = 'auto';
            battleLogContainer.style.width = '350px';
            battleLogContainer.style.height = '300px';
            
            // Load saved position from localStorage
            const savedPosition = localStorage.getItem('battleLogPosition');
            if (savedPosition) {
                try {
                    const position = JSON.parse(savedPosition);
                    if (position.x !== undefined && position.y !== undefined) {
                        console.log(`[setupBattleLog] Loading saved position: ${position.x}, ${position.y}`);
                        battleLogContainer.style.right = 'auto';
                        battleLogContainer.style.bottom = 'auto';
                        battleLogContainer.style.left = position.x + 'px';
                        battleLogContainer.style.top = position.y + 'px';
                        
                        // Set the offset variables for dragging - REMOVED: now handled in drag initialization
                    }
                } catch (error) {
                    console.warn('[setupBattleLog] Failed to parse saved position:', error);
                }
            }
            
            // Load saved visibility from localStorage
            const savedVisibility = localStorage.getItem('battleLogVisible');
            if (savedVisibility === 'false') {
                console.log('[setupBattleLog] Loading saved visibility: hidden');
                battleLogContainer.style.display = 'none';
                if (showLogButton) {
                    showLogButton.style.display = 'block';
                }
            } else {
                console.log('[setupBattleLog] Loading saved visibility: visible');
                battleLogContainer.style.display = 'flex';
                if (showLogButton) {
                    showLogButton.style.display = 'none';
                }
            }
            
            console.log('[setupBattleLog] Battle log initialized with saved position and visibility');
            
            // Dragging functionality
            let isDragging = false;
            let currentX = 0;
            let currentY = 0;
            let initialX = 0;
            let initialY = 0;
            let xOffset = 0;
            let yOffset = 0;
            
            // Initialize drag variables with saved position if available
            if (savedPosition) {
                try {
                    const position = JSON.parse(savedPosition);
                    if (position.x !== undefined && position.y !== undefined) {
                        xOffset = position.x;
                        yOffset = position.y;
                        currentX = position.x;
                        currentY = position.y;
                    }
                } catch (error) {
                    console.warn('[setupBattleLog] Failed to parse saved position for drag variables:', error);
                }
            }
            
            function setTranslate(xPos, yPos, el) {
                el.style.position = 'fixed';
                el.style.left = xPos + 'px';
                el.style.top = yPos + 'px';
                el.style.right = 'auto';
                el.style.bottom = 'auto';
            }
            
            function dragStart(e) {
                if (e.type === "touchstart") {
                    initialX = e.touches[0].clientX - xOffset;
                    initialY = e.touches[0].clientY - yOffset;
                } else {
                    initialX = e.clientX - xOffset;
                    initialY = e.clientY - yOffset;
                }
                
                if (e.target === dragHandle || dragHandle.contains(e.target)) {
                    isDragging = true;
                    battleLogContainer.style.cursor = 'grabbing';
                    dragHandle.style.cursor = 'grabbing';
                }
            }
            
            function dragEnd(e) {
                initialX = currentX;
                initialY = currentY;
                isDragging = false;
                battleLogContainer.style.cursor = '';
                dragHandle.style.cursor = 'grab';
                
                // Save position to localStorage
                const position = { x: currentX, y: currentY };
                localStorage.setItem('battleLogPosition', JSON.stringify(position));
            }
            
            function drag(e) {
                if (isDragging) {
                    e.preventDefault();
                    
                    if (e.type === "touchmove") {
                        currentX = e.touches[0].clientX - initialX;
                        currentY = e.touches[0].clientY - initialY;
                    } else {
                        currentX = e.clientX - initialX;
                        currentY = e.clientY - initialY;
                    }
                    
                    // Keep the log within viewport bounds
                    const containerRect = battleLogContainer.getBoundingClientRect();
                    const maxX = window.innerWidth - containerRect.width;
                    const maxY = window.innerHeight - containerRect.height;
                    
                    currentX = Math.max(0, Math.min(currentX, maxX));
                    currentY = Math.max(0, Math.min(currentY, maxY));
                    
                    xOffset = currentX;
                    yOffset = currentY;
                    
                    setTranslate(currentX, currentY, battleLogContainer);
                }
            }
            
            // Add event listeners for dragging
            if (dragHandle) {
                dragHandle.addEventListener('mousedown', dragStart);
                dragHandle.style.cursor = 'grab';
            }
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', dragEnd);
            
            // Touch events for mobile
            if (dragHandle) {
                dragHandle.addEventListener('touchstart', dragStart);
            }
            document.addEventListener('touchmove', drag);
            document.addEventListener('touchend', dragEnd);
            
            // Button functionality
            if (toggleReductionMessagesButton) {
                // Initialize button appearance based on current setting
                const updateReductionToggleButton = () => {
                    if (window.gameManager && window.gameManager.shouldShowReductionMessages()) {
                        toggleReductionMessagesButton.style.opacity = '1';
                        toggleReductionMessagesButton.title = 'Disable armor/shield reduction messages';
                        toggleReductionMessagesButton.style.background = 'rgba(0, 255, 0, 0.2)'; // Green tint when enabled
                    } else {
                        toggleReductionMessagesButton.style.opacity = '0.5';
                        toggleReductionMessagesButton.title = 'Enable armor/shield reduction messages';
                        toggleReductionMessagesButton.style.background = 'rgba(255, 0, 0, 0.2)'; // Red tint when disabled
                    }
                };
                
                toggleReductionMessagesButton.addEventListener('click', () => {
                    if (window.gameManager) {
                        const newState = window.gameManager.toggleReductionMessages();
                        updateReductionToggleButton();
                        console.log(`[setupBattleLog] Reduction messages ${newState ? 'enabled' : 'disabled'}`);
                    } else {
                        addBattleLogMessage('‚ö†Ô∏è Game manager not available', 'system');
                    }
                });
                
                // Update button appearance when game manager is available
                setTimeout(updateReductionToggleButton, 100);
            }
            
            if (clearLogButton) {
                clearLogButton.addEventListener('click', () => {
                    const battleLog = document.getElementById('battle-log');
                    if (battleLog) {
                        battleLog.innerHTML = '';
                        console.log('[setupBattleLog] Battle log cleared');
                        // Add a cleared message
                        addBattleLogMessage('üìã Battle log cleared', 'system');
                    }
                });
            }
            
            if (toggleLogButton) {
                toggleLogButton.addEventListener('click', () => {
                    const isCollapsed = battleLogContainer.classList.contains('collapsed');
                    if (isCollapsed) {
                        battleLogContainer.classList.remove('collapsed');
                        battleLogContainer.style.height = '300px';
                        toggleLogButton.textContent = '‚¨ç';
                        toggleLogButton.title = 'Collapse log';
                        console.log('[setupBattleLog] Battle log expanded');
                    } else {
                        battleLogContainer.classList.add('collapsed');
                        battleLogContainer.style.height = '180px';
                        toggleLogButton.textContent = '‚¨å';
                        toggleLogButton.title = 'Expand log';
                        console.log('[setupBattleLog] Battle log collapsed');
                    }
                });
            }
            
            if (closeLogButton) {
                closeLogButton.addEventListener('click', () => {
                    battleLogContainer.style.display = 'none';
                    if (showLogButton) {
                        showLogButton.style.display = 'block';
                    }
                    localStorage.setItem('battleLogVisible', 'false');
                    console.log('[setupBattleLog] Battle log hidden');
                });
            }
            
            if (showLogButton) {
                showLogButton.addEventListener('click', () => {
                    battleLogContainer.style.display = 'flex';
                    showLogButton.style.display = 'none';
                    localStorage.setItem('battleLogVisible', 'true');
                    console.log('[setupBattleLog] Battle log shown');
                });
            }
            
            // Global function to add battle log messages (available throughout the game)
            window.addBattleLogMessage = function(message, className = '') {
                console.log(`[addBattleLogMessage] Adding: ${message} (class: ${className})`);
                
                const battleLog = document.getElementById('battle-log');
                if (!battleLog) {
                    console.error('[addBattleLogMessage] Battle log element not found!');
                    return;
                }
                
                const entry = document.createElement('div');
                entry.className = `log-entry ${className}`;
                
                // Create message text element
                const messageText = document.createElement('span');
                messageText.className = 'log-message';
                messageText.textContent = message;
                entry.appendChild(messageText);
                
                // Add timestamp
                const now = new Date();
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const seconds = String(now.getSeconds()).padStart(2, '0');
                const timestamp = `${hours}:${minutes}:${seconds}`;
                
                const timestampElement = document.createElement('span');
                timestampElement.className = 'battle-log-timestamp';
                timestampElement.textContent = timestamp;
                entry.appendChild(timestampElement);
                
                battleLog.appendChild(entry);
                
                // Auto-scroll to bottom
                const contentElement = document.querySelector('.battle-log-content');
                if (contentElement) {
                    contentElement.scrollTop = contentElement.scrollHeight;
                }
                
                // Flash the header for important messages
                if (className === 'critical' || className === 'system') {
                    const headerElement = document.querySelector('.battle-log-header');
                    if (headerElement) {
                        headerElement.classList.add('flash');
                        setTimeout(() => {
                            headerElement.classList.remove('flash');
                        }, 500);
                    }
                }
                
                console.log(`[addBattleLogMessage] Message added successfully`);
            };
            
            // Add debug function to reset battle log position
            window.resetBattleLogPosition = () => {
                console.log('[DEBUG] Resetting battle log position...');
                localStorage.removeItem('battleLogPosition');
                localStorage.removeItem('battleLogVisible');
                battleLogContainer.style.position = 'fixed';
                battleLogContainer.style.right = '20px';
                battleLogContainer.style.bottom = '20px';
                battleLogContainer.style.left = 'auto';
                battleLogContainer.style.top = 'auto';
                battleLogContainer.style.display = 'flex';
                battleLogContainer.style.visibility = 'visible';
                battleLogContainer.style.opacity = '1';
                battleLogContainer.style.width = '350px';
                battleLogContainer.style.height = '300px';
                if (showLogButton) {
                    showLogButton.style.display = 'none';
                }
                console.log('[DEBUG] Battle log position reset to default');
                addBattleLogMessage('üîß Battle log position reset!', 'system');
            };
            
            // Add debug function to test battle log
            window.testBattleLog = () => {
                console.log('[DEBUG] Testing battle log...');
                addBattleLogMessage('üß™ Test message 1: Normal message', '');
                addBattleLogMessage('‚ö†Ô∏è Test message 2: Critical message', 'critical');
                addBattleLogMessage('üõ°Ô∏è Test message 3: System message', 'system');
                addBattleLogMessage('‚ù§Ô∏è Test message 4: Heal message', 'heal');
                addBattleLogMessage('üèÜ Test message 5: Player turn', 'player-turn');
                addBattleLogMessage('üëπ Test message 6: Enemy turn', 'enemy-turn');
                console.log('[DEBUG] Test messages added');
            };
            
            // Add debug function to toggle reduction messages
            window.toggleReductionMessages = () => {
                if (window.gameManager) {
                    const newState = window.gameManager.toggleReductionMessages();
                    console.log(`[DEBUG] Reduction messages ${newState ? 'enabled' : 'disabled'}`);
                    return newState;
                } else {
                    console.warn('[DEBUG] Game manager not available');
                    return false;
                }
            };
            
            // Add debug function to test reduction messages
            window.testReductionMessages = () => {
                if (window.gameManager && window.gameManager.shouldShowReductionMessages()) {
                    addBattleLogMessage("üõ°Ô∏è Test armor reduction: Alice's armor reduces physical damage by 25% (100 ‚Üí 75)", 'armor-reduction');
                    addBattleLogMessage("‚ú® Test shield reduction: Bob's magical shield reduces magical damage by 30% (80 ‚Üí 56)", 'shield-reduction');
                    console.log('[DEBUG] Test reduction messages added (they are enabled)');
                } else {
                    console.log('[DEBUG] Reduction messages are disabled - no test messages shown');
                }
            };
            
            // Add keyboard shortcut for battle log visibility (Ctrl+L)
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 'l') {
                    e.preventDefault();
                    const isVisible = battleLogContainer.style.display !== 'none';
                    if (isVisible) {
                        battleLogContainer.style.display = 'none';
                        if (showLogButton) {
                            showLogButton.style.display = 'block';
                        }
                        console.log('[setupBattleLog] Battle log hidden via Ctrl+L');
                    } else {
                        battleLogContainer.style.display = 'flex';
                        if (showLogButton) {
                            showLogButton.style.display = 'none';
                        }
                        console.log('[setupBattleLog] Battle log shown via Ctrl+L');
                    }
                }
            });
            
            // Add comprehensive test messages immediately
            setTimeout(() => {
                console.log('[setupBattleLog] Adding initial test messages...');
                addBattleLogMessage('‚öîÔ∏è Battle Log Initialized - Ready for Battle!', 'system');
                addBattleLogMessage('üìç Battle log is working properly', 'system');
                addBattleLogMessage('üõ°Ô∏è Armor/Shield reduction messages are ON by default', 'system');
                addBattleLogMessage('‚å®Ô∏è Press Ctrl+L to toggle battle log visibility', 'system');
                addBattleLogMessage('üîß Type testBattleLog() in console to test messages', 'system');
                addBattleLogMessage('üîÑ Type resetBattleLogPosition() to reset position', 'system');
                addBattleLogMessage('üõ°Ô∏è Type toggleReductionMessages() to toggle reduction messages', 'system');
                addBattleLogMessage('üß™ Type testReductionMessages() to test reduction display', 'system');
                console.log('[setupBattleLog] Initial test messages added');
            }, 100);
            
            console.log('[setupBattleLog] Battle log setup complete!');
        }

        // Setup talents panel controls
        function setupTalentsPanel() {
            const talentsPanel = document.getElementById('talents-panel');
            const toggleTalentsButton = document.getElementById('toggle-talents-panel');
            const showTalentsButton = document.getElementById('show-talents-button');
            
            // Toggle talents panel visibility
            toggleTalentsButton.addEventListener('click', () => {
                talentsPanel.classList.toggle('collapsed');
                showTalentsButton.style.display = talentsPanel.classList.contains('collapsed') ? 'block' : 'none';
                
                // Update button text based on state
                toggleTalentsButton.textContent = talentsPanel.classList.contains('collapsed') ? '‚ñ∂' : '‚óÄ';
                toggleTalentsButton.title = talentsPanel.classList.contains('collapsed') ? 'Show talents' : 'Hide talents';
            });
            
            // Show talents panel when clicking the show button
            showTalentsButton.addEventListener('click', () => {
                talentsPanel.classList.remove('collapsed');
                showTalentsButton.style.display = 'none';
                toggleTalentsButton.textContent = '‚óÄ';
                toggleTalentsButton.title = 'Hide talents';
            });
        }

        // Quest notification functions
        function showQuestCompletionNotification(quest) {
            // Remove any existing notifications after a delay to prevent overlap
            const existingNotifications = document.querySelectorAll('.quest-completion-notification');
            
            const notification = document.createElement('div');
            notification.className = 'quest-completion-notification';
            notification.innerHTML = `
                <div class="quest-completion-content">
                    <div class="quest-completion-icon">${quest.icon}</div>
                    <div class="quest-completion-text">
                        <div class="quest-completion-title">Quest Complete!</div>
                        <div class="quest-completion-name">${quest.name}</div>
                        <div class="quest-completion-reward">üéÅ ${quest.reward.name}</div>
                        <div class="quest-completion-progress">Progress: ${quest.target}/${quest.target}</div>
                    </div>
                </div>
            `;

            document.body.appendChild(notification);

            // Show notification with slight delay for stacking effect
            setTimeout(() => {
                notification.classList.add('show');
            }, existingNotifications.length * 100 + 100);

            // Hide notification after 6 seconds
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 600); // Wait for animation to complete
            }, 6000);

            // Add celebration effect to battle log
            if (window.gameManager) {
                window.gameManager.addLogEntry(
                    `üéâ Quest Completed: "${quest.name}" - Reward: ${quest.reward.name}`,
                    'quest-complete'
                );
            }
        }

        function showQuestProgressNotification(message) {
            // Remove any existing progress notification
            const existingProgress = document.querySelector('.quest-progress-notification');
            if (existingProgress) {
                existingProgress.remove();
            }

            const notification = document.createElement('div');
            notification.className = 'quest-progress-notification';
            notification.textContent = message;

            document.body.appendChild(notification);

            // Show notification
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);

            // Hide notification after 3 seconds
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 400);
            }, 3000);
        }

        // Listen for quest events
        if (typeof window !== 'undefined') {
            window.addEventListener('questCompleted', (event) => {
                const quest = event.detail.quest;
                console.log('[RAID-GAME] Quest completed:', quest.name);
                showQuestCompletionNotification(quest);
            });

            window.addEventListener('questProgress', (event) => {
                const { questName, progress, target } = event.detail;
                if (progress % 10 === 0 || progress === target) { // Show every 10 progress or on completion
                    showQuestProgressNotification(`üìà ${questName}: ${progress}/${target}`);
                }
            });
        }

        // DEBUG: Numpad keys for debug cheats (available to all users)
        function setupDebugKeys() {
            document.addEventListener('keydown', (e) => {
                // Available to all authenticated users
                if (firebaseAuth.currentUser) {
                    // --- Updated NUM1 cheat - Set ally mana to 10% ---
                    if (e.code === 'Numpad1' || (e.code === 'Digit1' && e.location === 0)) {
                        e.preventDefault();
                        setAllAllyManaTo10Percent();
                    }
                    // --- NUM2 cheat - Set ally HP to 10% ---
                    else if (e.code === 'Numpad2' || (e.code === 'Digit2' && e.location === 0)) {
                        e.preventDefault();
                        setAllAllyHPTo10Percent();
                    }
                    // --- NEW DEBUG CHEATS ---
                    else if (e.code === 'Numpad9' || (e.code === 'Digit9' && e.location === 0)) { // Enemy HP to 1%
                        e.preventDefault();
                        setAllEnemyHPTo1Percent();
                    } else if (e.code === 'Numpad8' || (e.code === 'Digit8' && e.location === 0)) { // Ally Mana 100%
                        e.preventDefault();
                        setAllAllyManaToFull();
                    } else if (e.code === 'Numpad7' || (e.code === 'Digit7' && e.location === 0)) { // Ally HP 100%
                        e.preventDefault();
                        setAllAllyHPToFull();
                    } else if (e.code === 'Numpad6' || (e.code === 'Digit6' && e.location === 0)) { // +100 Physical Damage
                        e.preventDefault();
                        giveAllAlliesPhysicalDamage(100);
                    } else if (e.code === 'Numpad5' || (e.code === 'Digit5' && e.location === 0)) { // +100 Magical Damage
                        e.preventDefault();
                        giveAllAlliesMagicalDamage(100);
                    } else if (e.code === 'Numpad4' || (e.code === 'Digit4' && e.location === 0)) { // Toggle 100% Dodge
                        e.preventDefault();
                        toggleAllAlliesDodgeChance();
                    } else if (e.code === 'Numpad3' || (e.code === 'Digit3' && e.location === 0)) { // Reset cooldowns
                        e.preventDefault();
                        resetAllAllyCooldowns();
                    }
                }
            });
        }

        function setAllAllyManaTo10Percent() {
            if (!window.gameManager || !window.gameManager.gameState) {
                console.log('[DEBUG NUM1] Game manager not available');
                return;
            }

            const playerCharacters = window.gameManager.gameState.playerCharacters;
            if (!playerCharacters || playerCharacters.length === 0) {
                console.log('[DEBUG NUM1] No player characters found');
                return;
            }

            console.log('[DEBUG NUM1] Setting all ally mana to 10%...');
            
            playerCharacters.forEach(character => {
                if (!character.isDead()) {
                    const maxMana = character.stats.maxMana || character.stats.mana || character.stats.currentMana || 100;
                    const newMana = Math.max(1, Math.floor(maxMana * 0.1)); // 10% mana, minimum 1
                    const oldMana = character.stats.currentMana;
                    
                    character.stats.currentMana = newMana;
                    
                    console.log(`[DEBUG NUM1] ${character.name}: ${oldMana} ‚Üí ${newMana} Mana (10% of ${maxMana})`);
                    
                    // Update UI
                    if (window.gameManager.uiManager) {
                        window.gameManager.uiManager.updateCharacterUI(character);
                    }
                }
            });

            // Add log entry
            if (window.gameManager.addLogEntry) {
                window.gameManager.addLogEntry('üîß DEBUG: All ally mana set to 10%', 'system');
            }

            console.log('[DEBUG NUM1] All ally mana set to 10% complete');
        }

        function setAllAllyHPTo10Percent() {
            if (!window.gameManager || !window.gameManager.gameState) {
                console.log('[DEBUG NUM2] Game manager not available');
                return;
            }

            const playerCharacters = window.gameManager.gameState.playerCharacters;
            if (!playerCharacters || playerCharacters.length === 0) {
                console.log('[DEBUG NUM2] No player characters found');
                return;
            }

            console.log('[DEBUG NUM2] Setting all ally HP to 10%...');
            
            playerCharacters.forEach(character => {
                if (!character.isDead()) {
                    const maxHp = character.stats.maxHp || character.stats.hp || 1000;
                    const newHp = Math.max(1, Math.floor(maxHp * 0.1)); // 10% HP, minimum 1
                    const oldHp = character.stats.currentHp;
                    
                    character.stats.currentHp = newHp;
                    
                    console.log(`[DEBUG NUM2] ${character.name}: ${oldHp} ‚Üí ${newHp} HP (10% of ${maxHp})`);
                    
                    // Update UI
                    if (window.gameManager.uiManager) {
                        window.gameManager.uiManager.updateCharacterUI(character);
                    }
                }
            });

            // Add log entry
            if (window.gameManager.addLogEntry) {
                window.gameManager.addLogEntry('üîß DEBUG: All ally HP set to 10%', 'system');
            }

            console.log('[DEBUG NUM2] All ally HP set to 10% complete');
        }

        // --- BEGIN NEW DEBUG UTILITY FUNCTIONS ---
        let debugDodgeEnabled = false; // Tracks dodge toggle state

        function setAllEnemyHPTo1Percent() {
            if (window.gameManager && typeof window.gameManager.activateEnemyLowHPCheat === 'function') {
                window.gameManager.activateEnemyLowHPCheat();
                return;
            }
            if (!window.gameManager || !window.gameManager.gameState) {
                console.log('[DEBUG NUM9] Game manager not available');
                return;
            }
            const enemies = window.gameManager.gameState.aiCharacters || [];
            enemies.forEach(enemy => {
                if (!enemy.isDead()) {
                    const maxHp = enemy.stats.maxHp || enemy.stats.hp || 1000;
                    enemy.stats.currentHp = Math.max(1, Math.floor(maxHp * 0.01));
                    if (window.gameManager.uiManager) {
                        window.gameManager.uiManager.updateCharacterUI(enemy);
                    }
                }
            });
            window.gameManager.addLogEntry('üîß DEBUG: All enemy HP set to 1%', 'system');
        }

        function setAllAllyManaToFull() {
            if (!window.gameManager || !window.gameManager.gameState) return;
            const allies = window.gameManager.gameState.playerCharacters || [];
            allies.forEach(char => {
                if (!char.isDead()) {
                    char.stats.currentMana = char.stats.maxMana || char.stats.mana || char.stats.currentMana;
                    if (window.gameManager.uiManager) window.gameManager.uiManager.updateCharacterUI(char);
                }
            });
            window.gameManager.addLogEntry('üîß DEBUG: All ally mana set to 100%', 'system');
        }

        function setAllAllyHPToFull() {
            if (!window.gameManager || !window.gameManager.gameState) return;
            const allies = window.gameManager.gameState.playerCharacters || [];
            allies.forEach(char => {
                if (!char.isDead()) {
                    const maxHp = char.stats.maxHp || char.stats.hp || 1000;
                    char.stats.currentHp = maxHp;
                    if (window.gameManager.uiManager) window.gameManager.uiManager.updateCharacterUI(char);
                }
            });
            window.gameManager.addLogEntry('üîß DEBUG: All ally HP set to 100%', 'system');
        }

        function giveAllAlliesPhysicalDamage(amount = 100) {
            if (!window.gameManager || !window.gameManager.gameState) return;
            window.gameManager.gameState.playerCharacters.forEach(char => {
                char.stats.physicalDamage = (char.stats.physicalDamage || 0) + amount;
            });
            window.gameManager.addLogEntry(`üîß DEBUG: All allies gained +${amount} Physical Damage`, 'system');
        }

        function giveAllAlliesMagicalDamage(amount = 100) {
            if (!window.gameManager || !window.gameManager.gameState) return;
            window.gameManager.gameState.playerCharacters.forEach(char => {
                char.stats.magicalDamage = (char.stats.magicalDamage || 0) + amount;
            });
            window.gameManager.addLogEntry(`üîß DEBUG: All allies gained +${amount} Magical Damage`, 'system');
        }

        function toggleAllAlliesDodgeChance() {
            if (!window.gameManager || !window.gameManager.gameState) return;
            const allies = window.gameManager.gameState.playerCharacters;
            if (!debugDodgeEnabled) {
                allies.forEach(char => {
                    char._originalDodgeChance = char.stats.dodgeChance || 0;
                    char.stats.dodgeChance = 1;
                });
                window.gameManager.addLogEntry('üîß DEBUG: Allies dodge chance set to 100%', 'system');
            } else {
                allies.forEach(char => {
                    if (char._originalDodgeChance !== undefined) {
                        char.stats.dodgeChance = char._originalDodgeChance;
                    }
                });
                window.gameManager.addLogEntry('üîß DEBUG: Allies dodge chance restored to original values', 'system');
            }
            debugDodgeEnabled = !debugDodgeEnabled;
        }

        function resetAllAllyCooldowns() {
            if (!window.gameManager || !window.gameManager.gameState) return;
            window.gameManager.gameState.playerCharacters.forEach(char => {
                if (Array.isArray(char.abilities)) {
                    char.abilities.forEach(ab => ab.currentCooldown = 0);
                }
                if (typeof window.gameManager.updateCharacterAbilities === 'function') {
                    window.gameManager.updateCharacterAbilities(char);
                }
            });
            window.gameManager.addLogEntry('üîß DEBUG: All ally ability cooldowns reset', 'system');
        }
        // --- END NEW DEBUG UTILITY FUNCTIONS ---

        // Setup page unload confirmation
        let gameHasStarted = false;
        let userHasInteracted = false;
        
        function setupPageUnloadConfirmation() {
            // Track user interaction (required by modern browsers for beforeunload)
            document.addEventListener('click', () => {
                userHasInteracted = true;
            }, { once: false });
            
            document.addEventListener('keydown', () => {
                userHasInteracted = true;
            }, { once: false });
            
            // Track when game actually starts
            window.addEventListener('gameStarted', () => {
                gameHasStarted = true;
                console.log('Game started - unload protection enabled');
            });
            
            // Setup beforeunload listener
            window.addEventListener('beforeunload', (event) => {
                // Show confirmation if game has started and user has interacted
                if (gameHasStarted && userHasInteracted) {
                    // Check if game is still active (not ended)
                    const gameStillActive = window.gameManager && 
                                          window.gameManager.gameState && 
                                          !window.gameManager.gameState.gameEnded;
                    
                    if (gameStillActive) {
                        // Modern browsers ignore custom messages and show their own
                        // But we still need to set returnValue and preventDefault
                        event.preventDefault();
                        event.returnValue = ''; // Empty string is sufficient for modern browsers
                        return ''; // Fallback for older browsers
                    }
                }
            });
            
            console.log('Page unload confirmation system initialized');
        }

        // Performance optimizations
        function enableGraphicsAcceleration() {
            // Enable hardware acceleration for supported browsers
            if ('requestIdleCallback' in window) {
                window.requestIdleCallback(() => {
                    // Force GPU layer creation for better performance
                    document.body.style.transform = 'translate3d(0, 0, 0)';
                });
            }
            
            // Optimize animations to use RAF
            if ('requestAnimationFrame' in window) {
                const originalSetTimeout = window.setTimeout;
                window.setTimeout = function(callback, delay) {
                    if (delay < 17) { // Less than one frame (60fps)
                        return window.requestAnimationFrame(callback);
                    }
                    return originalSetTimeout(callback, delay);
                };
            }
            
            // Preload critical CSS for better performance
            const criticalElements = document.querySelectorAll('.character-slot, .ability, .battle-log-container');
            criticalElements.forEach(el => {
                el.style.willChange = 'transform, opacity';
                el.style.transform = 'translate3d(0, 0, 0)';
            });
            
            console.log('Graphics acceleration enabled');
        }

        // Firebase error handling and connection management
        function setupFirebaseErrorHandling() {
            // Handle Firebase Database connection errors
            if (window.firebase && window.firebase.database) {
                const database = window.firebase.database();
                
                // Monitor connection state
                const connectedRef = database.ref('.info/connected');
                connectedRef.on('value', (snapshot) => {
                    const connected = snapshot.val();
                    console.log(`[Firebase] Connection state: ${connected ? 'Connected' : 'Disconnected'}`);
                    
                    if (!connected) {
                        console.warn('[Firebase] Database disconnected, attempting to reconnect...');
                        // Firebase will automatically attempt to reconnect
                    }
                });
                
                // Handle offline/online events
                window.addEventListener('online', () => {
                    console.log('[Firebase] Network back online, ensuring database connection...');
                    database.goOnline();
                });
                
                window.addEventListener('offline', () => {
                    console.log('[Firebase] Network offline, going offline...');
                    database.goOffline();
                });
            }
            
            // Global error handler for uncaught Firebase errors
            window.addEventListener('error', (event) => {
                if (event.error && event.error.message && 
                    (event.error.message.includes('sendRequest') || 
                     event.error.message.includes('PersistentConnection') ||
                     event.error.message.includes('firebase'))) {
                    
                    console.warn('[Firebase Error Handler] Caught Firebase connection error:', event.error);
                    
                    // Attempt to reinitialize Firebase connection
                    setTimeout(() => {
                        if (window.firebase && window.firebase.database) {
                            console.log('[Firebase Error Handler] Attempting to restore database connection...');
                            try {
                                const database = window.firebase.database();
                                database.goOffline();
                                setTimeout(() => {
                                    database.goOnline();
                                    console.log('[Firebase Error Handler] Database connection restored');
                                }, 1000);
                            } catch (error) {
                                console.error('[Firebase Error Handler] Failed to restore connection:', error);
                            }
                        }
                    }, 2000);
                    
                    // Prevent the error from bubbling up
                    event.preventDefault();
                    return false;
                }
            });
            
            // Handle unhandled promise rejections from Firebase
            window.addEventListener('unhandledrejection', (event) => {
                if (event.reason && event.reason.message && 
                    (event.reason.message.includes('firebase') || 
                     event.reason.message.includes('sendRequest'))) {
                    
                    console.warn('[Firebase Error Handler] Caught unhandled Firebase promise rejection:', event.reason);
                    event.preventDefault();
                    return false;
                }
            });
                 }

        // Global function to manually recover from Firebase issues
        window.recoverFirebaseConnection = function() {
            console.log('[Firebase Recovery] Attempting manual Firebase connection recovery...');
            
            try {
                if (window.firebase && window.firebase.database) {
                    const database = window.firebase.database();
                    
                    // Force offline then online to reset connection
                    database.goOffline();
                    console.log('[Firebase Recovery] Forced offline...');
                    
                    setTimeout(() => {
                        database.goOnline();
                        console.log('[Firebase Recovery] Forced online...');
                        
                        // Test connection after recovery
                        const testRef = database.ref('.info/connected');
                        testRef.once('value', (snapshot) => {
                            const connected = snapshot.val();
                            console.log(`[Firebase Recovery] Recovery test - Connected: ${connected}`);
                            
                            if (connected) {
                                console.log('[Firebase Recovery] Connection recovery successful!');
                                if (window.gameManager && window.gameManager.addLogEntry) {
                                    window.gameManager.addLogEntry('üîÑ Firebase connection recovered', 'system');
                                }
                            } else {
                                console.warn('[Firebase Recovery] Connection recovery failed');
                            }
                        });
                    }, 2000);
                    
                } else {
                    console.error('[Firebase Recovery] Firebase database not available for recovery');
                }
            } catch (error) {
                console.error('[Firebase Recovery] Error during recovery attempt:', error);
            }
        };

        // Initialize and start the game when page loads
        document.addEventListener('DOMContentLoaded', () => {
            // Enable graphics acceleration first
            enableGraphicsAcceleration();
            
            // Setup Firebase error handling
            setupFirebaseErrorHandling();
            
            // Get the loading element immediately after DOM is ready
            const loadingTextElement = document.getElementById('loading-text');
            if (!loadingTextElement) {
                console.error("Fatal Error: loading-text element not found immediately after DOMContentLoaded!");
                alert("Fatal Error: UI component missing. Cannot initialize game.");
                return;
            }

            // --- Wait for Firebase Auth State with timeout and retry --- 
            let authStateTimeout;
            let authRetryCount = 0;
            const maxAuthRetries = 3;
            
            function attemptFirebaseAuth() {
                authRetryCount++;
                console.log(`[Firebase Auth] Attempt ${authRetryCount}/${maxAuthRetries}`);
                
                // Clear any existing timeout
                if (authStateTimeout) {
                    clearTimeout(authStateTimeout);
                }
                
                // Set a timeout for auth state change
                authStateTimeout = setTimeout(() => {
                    console.warn('[Firebase Auth] Auth state change timeout, retrying...');
                    if (authRetryCount < maxAuthRetries) {
                        attemptFirebaseAuth();
                    } else {
                        console.error('[Firebase Auth] Max auth retries exceeded');
                        loadingTextElement.textContent = 'Authentication failed. Please refresh the page.';
                    }
                }, 10000); // 10 second timeout
            }
            
            attemptFirebaseAuth();
            
            firebaseAuth.onAuthStateChanged(async (user) => {
                // Clear the auth timeout since we got a response
                if (authStateTimeout) {
                    clearTimeout(authStateTimeout);
                }
                // Use the loadingTextElement variable captured from the outer scope
                // No need to getElementById again here

                if (user) {
                    console.log("User is authenticated, proceeding with game initialization.");
                    
                    // Verify Firebase Database is properly initialized
                    try {
                        if (!window.firebase || !window.firebase.database) {
                            throw new Error('Firebase Database not properly initialized');
                        }
                        
                        // Test database connection before proceeding
                        const testRef = window.firebase.database().ref('.info/serverTimeOffset');
                        await new Promise((resolve, reject) => {
                            const timeout = setTimeout(() => reject(new Error('Database connection test timeout')), 5000);
                            testRef.once('value', () => {
                                clearTimeout(timeout);
                                console.log('[Firebase] Database connection test successful');
                                resolve();
                            }, (error) => {
                                clearTimeout(timeout);
                                reject(error);
                            });
                        });
                    } catch (dbError) {
                        console.error('[Firebase] Database connection test failed:', dbError);
                        loadingTextElement.textContent = 'Database connection failed. Retrying...';
                        
                        // Retry after a delay
                        setTimeout(() => {
                            if (authRetryCount < maxAuthRetries) {
                                attemptFirebaseAuth();
                            } else {
                                loadingTextElement.textContent = 'Failed to connect to database. Please refresh the page.';
                            }
                        }, 3000);
                        return;
                    }
                    
                    try {
                        // Setup UI components that don't depend on game state yet
                        setupTooltip();
                        setupGameOverScreen();
                        setupBattleLog();
                        setupTalentsPanel();
                        setupPageUnloadConfirmation();
                        setupDebugKeys();

                        // Initialize Inventory System
                        if (typeof ItemRegistry !== 'undefined' && typeof GlobalInventory !== 'undefined') {
                            window.ItemRegistry = new ItemRegistry();
                            window.GlobalInventory = new GlobalInventory();
                            window.CharacterInventories = new Map();
                            
                            // Initialize inventory UI manager for raid game
                            if (typeof InventoryUIManager !== 'undefined') {
                                window.inventoryUIManager = new InventoryUIManager();
                            }
                            
                            // Initialize inventory integration manager
                            if (typeof InventoryIntegrationManager !== 'undefined') {
                                window.InventoryIntegrationManager = new InventoryIntegrationManager();
                                await window.InventoryIntegrationManager.initialize();
                                console.log('[RAID-GAME] Inventory system initialized');
                            }
                        }

                        // Initialize Loot System
                        if (typeof LootManager !== 'undefined') {
                            window.LootManager = new LootManager();
                            console.log('[RAID-GAME] Loot system initialized');
                        }

                        // Initialize Loot UI Manager
                        if (typeof LootUIManager !== 'undefined') {
                            window.LootUIManager = new LootUIManager();
                            console.log('[RAID-GAME] Loot UI system initialized');
                        }

                        // Initialize the talent manager if available
                        if (window.talentManager) {
                            await window.talentManager.initialize();
                        }

                        // Initialize the quest manager if available
                        if (window.questManager) {
                            await window.questManager.initialize();
                            console.log('[RAID-GAME] Quest manager initialized');
                        }

                        // Access the global gameManager (or create if needed)
                        // Ensure GameManager is defined or imported appropriately
                        if (typeof GameManager === 'undefined') {
                             throw new Error("GameManager class not found. Check script includes.");
                        }
                        window.gameManager = new GameManager(); // Create instance
                        await window.gameManager.initialize(); // Initialize managers
                        
                        // Get stageId (might be from URL for story mode, or default)
                        const urlParams = new URLSearchParams(window.location.search);
                        let stageId = urlParams.get('stage') || 'draft_mode_stage'; // Default to draft mode stage
                        const storyId = urlParams.get('storyId');
                        const stageIndex = urlParams.get('stageIndex');
                        const isWeeklyChallenge = urlParams.get('weekly') === 'true';
                        
                        // Enable weekly challenge mode if detected
                        if (isWeeklyChallenge) {
                            window.gameManager.enableWeeklyChallengeMode();
                            console.log('[RAID-GAME] Weekly Challenge Mode enabled for stage:', stageId);
                        }
                        
                        // Check for data from character selector in localStorage
                        const savedGameData = localStorage.getItem('raid_game_data');
                        if (savedGameData) {
                            try {
                                const gameData = JSON.parse(savedGameData);
                                if (gameData.stageId) {
                                    stageId = gameData.stageId;
                                    console.log(`Loading stage from localStorage: ${stageId}`);
                                }
                                
                                // Setup selected characters if provided
                                if (gameData.characters && Array.isArray(gameData.characters)) {
                                    window.gameManager.stageManager.customPlayerCharacters = gameData.characters;
                                    console.log(`Loading custom characters from localStorage: ${gameData.characters.join(', ')}`);
                                }
                                
                                // Clear localStorage after reading
                                localStorage.removeItem('raid_game_data');
                            } catch (error) {
                                console.error('Error parsing saved game data:', error);
                            }
                        }
                        
                        // If in story mode context, startGame will handle fetching correct stageId and state
                        // If not, it uses the stageId determined here.
                        console.log(`Attempting to start game. Story context: ${storyId ? storyId + '['+stageIndex+']' : 'None'}, Stage ID: ${stageId}`);
                        await window.gameManager.startGame(stageId); // Call the async startGame
                        
                        // Dispatch gameStarted event for unload protection
                        window.dispatchEvent(new CustomEvent('gameStarted'));

                        // Initialize the talents panel if the talents panel manager is available
                        if (window.talentsPanelManager) {
                            window.talentsPanelManager.initialize();
                        }

                        // Hide loading screen AFTER game state is loaded and ready
                        hideLoadingScreen();

                    } catch (error) {
                        console.error('Failed to initialize or start game:', error);
                        loadingTextElement.textContent = `Error initializing game: ${error.message}. Please try refreshing.`;
                        // Optionally hide loading screen even on error, or keep it showing the error
                        // hideLoadingScreen(); 
                    }
                } else {
                    // User is not logged in
                    console.log("User not authenticated. Redirecting to login...");
                    loadingTextElement.textContent = 'Redirecting to login...'; // Use the variable
                    // Add a small delay before redirecting to allow message visibility
                    setTimeout(() => {
                         window.location.href = 'index.html';
                    }, 1500);
                }
            });
            // --- End Firebase Auth Wait ---
        });

        console.log(">>> Setting up GLOBAL criticalHeal test listener <<<");
        document.addEventListener('criticalHeal', (event) => {
            console.log('%c>>> GLOBAL TEST LISTENER: criticalHeal event DETECTED! <<<', 'background: yellow; color: black; font-weight: bold;', event.detail);
            
            // Add specific check for Bridget
            if (event.detail && event.detail.source && event.detail.source.id === 'bridget') {
                console.log('%c>>> BRIDGET CRITICAL HEAL DETECTED! <<<', 'background: lime; color: black; font-size: 14px; font-weight: bold;');
                
                // Check if Bridget has the talent in her applied talents
                if (event.detail.source.appliedTalents) {
                    console.log('Bridget\'s applied talents:', event.detail.source.appliedTalents);
                    if (event.detail.source.appliedTalents.includes('aqueous_renewal')) {
                        console.log('%c>>> BRIDGET HAS AQUEOUS RENEWAL TALENT! <<<', 'background: blue; color: white; font-weight: bold;');
                    } else {
                        console.log('%c>>> BRIDGET DOES NOT HAVE AQUEOUS RENEWAL TALENT! <<<', 'background: red; color: white; font-weight: bold;');
                    }
                } else {
                    console.log('%c>>> BRIDGET HAS NO APPLIED TALENTS ARRAY! <<<', 'background: orange; color: black; font-weight: bold;');
                }
            }
        });

        // Quick Action Bar JS
        document.addEventListener('DOMContentLoaded', () => {
            const clickIfExists = (id) => {
                const el = document.getElementById(id);
                if (el) el.click();
            };

            document.getElementById('qab-quests').addEventListener('click', () => clickIfExists('quest-panel-toggle'));
            document.getElementById('qab-talents').addEventListener('click', () => clickIfExists('show-talents-button'));
            document.getElementById('qab-log').addEventListener('click', () => {
                // If battle log is hidden, show-log-button is visible, else close-log-button is present
                const showBtn = document.getElementById('show-log-button');
                if (showBtn && showBtn.style.display !== 'none') {
                    showBtn.click();
                } else {
                    clickIfExists('close-log-button');
                }
            });
            document.getElementById('qab-stats').addEventListener('click', () => clickIfExists('show-statistics-button'));
            document.getElementById('qab-inventory').addEventListener('click', () => {
                // Open global inventory modal
                if (window.inventoryUIManager) {
                    window.inventoryUIManager.openGlobalInventoryModal();
                } else {
                    console.warn('InventoryUIManager not available');
                }
            });
            document.getElementById('qab-consumables').addEventListener('click', () => {
                // Open consumable items window
                if (window.inventoryUIManager) {
                    window.inventoryUIManager.createConsumableWindow();
                } else {
                    console.warn('InventoryUIManager not available');
                }
            });
        });
    </script>
</body>
</html>
